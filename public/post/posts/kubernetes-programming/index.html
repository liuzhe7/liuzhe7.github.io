<!doctype html>































<html
  class="not-ready lg:text-base"
  style="--bg: #faf8f1"
  lang="en"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>怎么开发云原生应用？ - Paper</title>

  
  <meta name="theme-color" />

  
  
  
  
  <meta name="description" content="如果你想让你的应用充分利用kubernetes提供的能力，本文将提供一些思路和代码示例。" />
  <meta name="author" content="Liu Zhe" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="/main.min.css" />

  
  
  
  
  
  <link rel="preload" as="image" href="/theme.png" />

  
  
  
  
  

  
  
  <link rel="preload" as="image" href="/github.svg" />
  
  

  
  
  <script
    defer
    src="/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  
  

  
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.104.3" />

  
  
  
  
  
  <meta itemprop="name" content="怎么开发云原生应用？">
<meta itemprop="description" content="如果你想让你的应用充分利用kubernetes提供的能力，本文将提供一些思路和代码示例。"><meta itemprop="datePublished" content="2022-02-19T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-02-19T00:00:00+00:00" />
<meta itemprop="wordCount" content="1411">
<meta itemprop="keywords" content="kubernetes,cloud-native,golang," />
  
  <meta property="og:title" content="怎么开发云原生应用？" />
<meta property="og:description" content="如果你想让你的应用充分利用kubernetes提供的能力，本文将提供一些思路和代码示例。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/posts/kubernetes-programming/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-19T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-02-19T00:00:00+00:00" />


  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="怎么开发云原生应用？"/>
<meta name="twitter:description" content="如果你想让你的应用充分利用kubernetes提供的能力，本文将提供一些思路和代码示例。"/>

  
  
  
  <link rel="canonical" href="/post/posts/kubernetes-programming/" />
  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a
      class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold"
      href="/"
      >Paper</a
    >
    <div
      class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  

  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#faf8f1'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    
    <nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6">
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/about/"
        >About</a
      >
      
    </nav>
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href="https://github.com/liuzhe7"
        target="_blank"
        rel="me"
      >
        github
      </a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"
    >
      

<article>
  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">怎么开发云原生应用？</h1>

    
    <div class="text-sm antialiased opacity-60">
      
      <time>Feb 19, 2022</time>
      
      
      
      
    </div>
    
  </header>

  <section><p>如果你想让你的应用充分利用kubernetes提供的能力，本文将提供一些思路和代码示例。</p>
<ul>
<li><a href="#%E6%9C%AC%E6%96%87%E8%BE%83%E9%95%BF%E6%8A%8A%E9%87%8D%E8%A6%81%E7%BB%93%E8%AE%BA%E7%BD%AE%E9%A1%B6">本文较长，把重要结论置顶</a></li>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8">什么是云原生应用</a></li>
<li><a href="#client-go">client-go</a>
<ul>
<li><a href="#%E4%B9%90%E8%A7%82%E5%B9%B6%E5%8F%91">乐观并发</a></li>
<li><a href="#watch%E4%B8%8Einformer">watch与informer</a></li>
</ul>
</li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90">自定义资源</a>
<ul>
<li><a href="#cr%E4%B8%8Ecrd">CR与CRD</a></li>
<li><a href="#%E5%9C%A8%E7%A8%8B%E5%BA%8F%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90">在程序中使用自定义资源</a>
<ul>
<li><a href="#client-go%E5%8A%A8%E6%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF">client-go动态客户端</a></li>
<li><a href="#%E5%BC%BA%E7%B1%BB%E5%9E%8B%E5%AE%A2%E6%88%B7%E7%AB%AF">强类型客户端</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#k8siocode-generator">k8s.io/code-generator</a>
<ul>
<li><a href="#%E7%94%9F%E6%88%90%E5%99%A8%E8%AF%AD%E6%B3%95">生成器语法</a></li>
</ul>
</li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A7%E5%88%B6%E5%99%A8">自定义控制器</a></li>
<li><a href="#operator">Operator</a>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8kubebuilder">使用kubebuilder</a>
<ul>
<li><a href="#%E5%87%86%E5%85%A5-webhooks">准入 Webhooks</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="本文较长把重要结论置顶">本文较长，把重要结论置顶</h1>
<ul>
<li>
<p>如果程序运行在pod里，kubelet会自动挂在一个服务账号，路径是/var/run/secrets/kubernetes.io/serviceaccount，它可以替代kubeconfig文件。client-go里的rest.InClusterConfig()会自动去这个目录下找。</p>
</li>
<li>
<p>设置config.ContentType = &ldquo;application/vnd.kubernetes.protobuf&rdquo; 是为了让client-go使用protobuf编码访问kubernetes，这种格式比json更加轻量快速，但是自定义资源不支持。</p>
</li>
<li>
<p>kubernetes 的api服务对于两个并发的写请求，会拒绝后面一个。对于pod或其他资源的写请求，可能来自我们自己的代码也可能来自kubelet或其他组件，所以我们需要一直假设我这个请求可能是会被拒绝的。当一个对象的metadata.resourceVersion是最新的值，更新才能被接受。</p>
</li>
<li>
<p>watch过程中如果发生了错误或者调用了Stop()watch的channel会被关闭。</p>
</li>
<li>
<p>AllowWatchBookmarks设置为true，这表示我们启用了bookmark的能力。上面讲到的乐观锁机制，kubernetes的api只接受对最新版本对象的修改，如果我的watch断开连接重新连接后错过了几个event导致我缓存的不是最新版本对象了，那么我就要重新list一遍最新的对象，但是这太消耗资源了，Bookmark就是解决这个问题的，我只传resourceversion极大的减少了数据传输，拿到最新的版本号后，我的更新请求就又可以被接受了。</p>
</li>
<li>
<p>在实践中我们往往不直接使用watch，因为client-go还有informer机制，他对watch进行了封装，提供了缓存并加以索引查询。并且他能自动处理watch channel关闭的情况。informer帮我们保证了他的缓存中就是kubernetes集群中实际资源对象的最新状态。</p>
</li>
<li>
<p>共享informer工厂允许应用中不同控制循环共享一个watch连接，可以减少与kubernetes通信的压力。其中defaultResync代表我们多长时间要向 kubernetes api 进行一次list。</p>
</li>
<li>
<p>informerFactory.WaitForCacheSync(wait.NeverStop)表示代码要在这里等第一次list结束再往下执行，这对依赖缓存填充完毕的应用很重要。</p>
</li>
<li>
<p>在informer缓存机制下，我们不应该去修改informer缓存中的对象，这会造成难以排查的问题，一定要深拷贝后再修改。</p>
</li>
<li>
<p>自定的资源就和kubernetes自身的pod，deployment等一样，都是一等公民，都存放在etcd里。</p>
</li>
<li>
<p>动态类型客户端失去了方便性，获得了通用性，不需要在编译器就确定我要对哪种资源生效，一般用在垃圾回收控制器，不需要复杂的逻辑，只删除各种父对象已经不存在的子对象。</p>
</li>
<li>
<p>controller自己有一个工作队列，informer会把需要处理的资源对象放到队列里，controller每次从队列里取出资源都会检查他的实际状态（通过监控系统）与期望状态是否相符，如果相符就不需要操作，也不用再放回队列里。如果不相符，那么控制器需要进行调谐，改变实际状态，如果改变成功，就更新资源的status，同时不用再放回队列里了，如果改变失败还要放回队列里，等待下轮循环继续处理。</p>
</li>
<li>
<p>Operator实际上就是上面讲到的自定义资源(CR)自定义资源的定义(CRD)和用户的自定义控制器的一个总称，再细分一下就是CR+CRD+informer+workQueue+ContorllerLoop。</p>
</li>
<li>
<p>contorller 从workQueue里取出待调谐对象后去informer查最新情况也体现了kubernetes只关心最终状态的设计特点，另外对于notfound的err要忽略，因为它无法通过重试解决。</p>
</li>
<li>
<p>准入webhook有两种，都是作用在资源落库到etcd之前。一个用于修改api对象比如注入默认字段，另一个用于验证API对象的各个字段是否合法，这比crd里的schema的校验更加灵活。</p>
</li>
</ul>
<h1 id="什么是云原生应用">什么是云原生应用</h1>
<p>对于非云原生应用，它设计之初不会考虑将来要运行在kubernetes上，也许它只是运行在虚拟机，或者docker，现在迁移到了kubernetes集群中，被kubernetes管理，但是它本身并不会去访问kubernetes的api服务。</p>
<p>对于云原生应用则相反，他设计之初就是考虑到要利用kubernetes的能力，它会调用kubernetes的api，因此大部分时候它也只能部署在kubernetes。但是好处是，现在云服务商大规模的使用kubernetes，因此它可以很方便的在服务商之间迁移，并且kubernetes声明式的机制，能帮我我们完成一些应用的自动化运维。</p>
<h1 id="client-go">client-go</h1>
<p>client-go是一个典型的web服务客户端，它支持kubernetes中所有官方的API类型。下面代码用client-go在kubernetes集群中对一个pod进行CURD。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">corev1</span> <span style="color:#e6db74">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/rest&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAMESPACE</span> = <span style="color:#e6db74">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAME</span> = <span style="color:#e6db74">&#34;foo&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">Config</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">env</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;KUBECONFIG&#34;</span>); len(<span style="color:#a6e22e">env</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">inClusterConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">InClusterConfig</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">inClusterConfig</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">kubeconfig</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;kubeconfig&#34;</span>, <span style="color:#e6db74">&#34;~/.kube/config&#34;</span>, <span style="color:#e6db74">&#34;kubeconfig file&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flagConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientcmd</span>.<span style="color:#a6e22e">BuildConfigFromFlags</span>(<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">kubeconfig</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">flagConfig</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">AcceptContentTypes</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf,application/json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ContentType</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">clientSet</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">config</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Pod</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ObjectMeta</span>: <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">NAME</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Labels</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>				<span style="color:#e6db74">&#34;k&#34;</span>: <span style="color:#e6db74">&#34;v&#34;</span>,
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Spec</span>: <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">PodSpec</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Containers</span>: []<span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Container</span>{
</span></span><span style="display:flex;"><span>				{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;busybox&#34;</span>, <span style="color:#a6e22e">Image</span>: <span style="color:#e6db74">&#34;busybox:latest&#34;</span>, <span style="color:#a6e22e">Command</span>: []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;sleep&#34;</span>, <span style="color:#e6db74">&#34;1000&#34;</span>}},
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">CreateOptions</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;create pods err:%s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">NAME</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">GetOptions</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;get pods err:%s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">ObjectMeta</span>.<span style="color:#a6e22e">Labels</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ticker</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">NewTicker</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">times</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ticker</span>.<span style="color:#a6e22e">Stop</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ticker</span>.<span style="color:#a6e22e">C</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">NAME</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">GetOptions</span>{})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;get pods err:%s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">ObjectMeta</span>.<span style="color:#a6e22e">Labels</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;patch&#34;</span>: <span style="color:#e6db74">&#34;v1&#34;</span>}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">UpdateOptions</span>{})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;update pods err:%s\n&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">times</span> &gt; <span style="color:#ae81ff">3</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;we will try again in 3 second&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">times</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">NAME</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">GetOptions</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;get pods err:%s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">ObjectMeta</span>.<span style="color:#a6e22e">Labels</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">NAME</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">DeleteOptions</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;get pods err:%s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>首先要读取集群的配置文件，里面包含了服务器名称，身份认证信息等客户端数据。
<strong>如果程序运行在pod里，kubelet会自动挂在一个服务账号，路径是/var/run/secrets/kubernetes.io/serviceaccount，它可以替代kubeconfig文件。client-go里的rest.InClusterConfig()会自动去这个目录下找。</strong>
所以我们通过环境变量判断是否运行在容器，然后分别用 rest.InClusterConfig 和 clientcmd.BuildConfigFromFlags 获取两种场景下的配置文件。<strong>设置config.ContentType = &ldquo;application/vnd.kubernetes.protobuf&rdquo; 是为了让client-go使用protobuf编码访问kubernetes，这种格式比json更加轻量快速，但是自定义资源不支持。</strong>
然后初始化客户端，之后客户端分别进行了对pod的CURD操作。</p>
<h2 id="乐观并发">乐观并发</h2>
<p>在上面的代码中，对pod进行修改的时候，我们又get了一次集群中的pod，并且整个过程放在了循环里。这是因为kubernetes的api服务采用的乐观并发的模型。<strong>kubernetes 的api服务对于两个并发的写请求，会拒绝后面一个。对于pod或其他资源的写请求，可能来自我们自己的代码也可能来自kubelet或其他组件，所以我们需要一直假设我这个请求可能是会被拒绝的。当一个对象的metadata.resourceVersion是最新的值，更新才能被接受。</strong></p>
<h2 id="watch与informer">watch与informer</h2>
<p>watch 提供了发现对象各种变化的机制，如添加、删除、更新。下面代码实现了对default namespace内 pod 的watch</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v1</span> <span style="color:#e6db74">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/watch&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/rest&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAMESPACE</span> = <span style="color:#e6db74">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAME</span> = <span style="color:#e6db74">&#34;foo&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">Config</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">env</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;KUBECONFIG&#34;</span>); len(<span style="color:#a6e22e">env</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">inClusterConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">InClusterConfig</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">inClusterConfig</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">kubeconfig</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;kubeconfig&#34;</span>, <span style="color:#e6db74">&#34;~/.kube/config&#34;</span>, <span style="color:#e6db74">&#34;kubeconfig file&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flagConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientcmd</span>.<span style="color:#a6e22e">BuildConfigFromFlags</span>(<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">kubeconfig</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">flagConfig</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">AcceptContentTypes</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf,application/json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ContentType</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">clientSet</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">config</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">watcher</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Watch</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListOptions</span>{<span style="color:#a6e22e">AllowWatchBookmarks</span>: <span style="color:#66d9ef">true</span>})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">event</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">watcher</span>.<span style="color:#a6e22e">ResultChan</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Type</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Added</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;added evnet from %s\n&#34;</span>, <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>).<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Modified</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;modified evnet from %s\n&#34;</span>, <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>).<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Deleted</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;deleted evnet from %s\n&#34;</span>, <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>).<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Bookmark</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;`Bookmark` means watch has synced here, just update the resourceVersion&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Error</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;unable to understand watch event%v\n&#34;</span>, <span style="color:#a6e22e">event</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;watcher channel closed&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>首先通过clientSet创建一个 watch pod 的 watcher，watcher.ResultChan()会返回一个只能接收的channel，所有被watch到的事件都会被发送到这个channel中。其中有两点需要注意。</p>
<ul>
<li><strong>watch过程中如果发生了错误或者调用了Stop()watch的channel会被关闭。</strong></li>
<li><strong>AllowWatchBookmarks设置为true，这表示我们启用了bookmark的能力。上面讲到的乐观锁机制，kubernetes的api只接受对最新版本对象的修改，如果我的watch断开连接重新连接后错过了几个event导致我缓存的不是最新版本对象了，那么我就要重新list一遍最新的对象，但是这太消耗资源了，Bookmark就是解决这个问题的，我只传resourceversion极大的减少了数据传输，拿到最新的版本号后，我的更新请求就又可以被接受了。</strong></li>
</ul>
<p><strong>在实践中我们往往不直接使用watch，因为client-go还有informer机制，他对watch进行了封装，提供了缓存并加以索引查询。并且他能自动处理watch channel关闭的情况。informer帮我们保证了他的缓存中就是kubernetes集群中实际资源对象的最新状态。</strong></p>
<p>下面代码实现了一个informer。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v1</span> <span style="color:#e6db74">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/util/wait&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/informers&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/rest&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/tools/cache&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAMESPACE</span> = <span style="color:#e6db74">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAME</span> = <span style="color:#e6db74">&#34;foo&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">Config</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">env</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;KUBECONFIG&#34;</span>); len(<span style="color:#a6e22e">env</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">inClusterConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">InClusterConfig</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">inClusterConfig</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">kubeconfig</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;kubeconfig&#34;</span>, <span style="color:#e6db74">&#34;~/.kube/config&#34;</span>, <span style="color:#e6db74">&#34;kubeconfig file&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flagConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientcmd</span>.<span style="color:#a6e22e">BuildConfigFromFlags</span>(<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">kubeconfig</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">flagConfig</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">AcceptContentTypes</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf,application/json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ContentType</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">clientSet</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">config</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">informerFactory</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">informers</span>.<span style="color:#a6e22e">NewSharedInformerFactory</span>(<span style="color:#a6e22e">clientSet</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span><span style="color:#f92672">*</span><span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">podInformer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">informerFactory</span>.<span style="color:#a6e22e">Core</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">Pods</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">podInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">AddFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;add pod :%s\n&#34;</span>, <span style="color:#a6e22e">obj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>).<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">UpdateFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">oldObj</span>, <span style="color:#a6e22e">newObj</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;update pod :%s\n&#34;</span>, <span style="color:#a6e22e">oldObj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>).<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">DeleteFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;delete pod :%s\n&#34;</span>, <span style="color:#a6e22e">obj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>).<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">informerFactory</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NeverStop</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">informerFactory</span>.<span style="color:#a6e22e">WaitForCacheSync</span>(<span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NeverStop</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NeverStop</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>我们用共享informer工厂创建了一个pod的informer，<strong>共享informer工厂允许应用中不同控制循环共享一个watch连接，可以减少与kubernetes通信的压力。其中defaultResync代表我们多长时间要向 kubernetes api 进行一次list。</strong></p>
<p><strong>informerFactory.WaitForCacheSync(wait.NeverStop)表示代码要在这里等第一次list结束再往下执行，这对依赖缓存填充完毕的应用很重要。</strong></p>
<p><strong>在这种缓存机制下，我们不应该去修改informer缓存中的对象，这会造成难以排查的问题，一定要深拷贝后再修改。</strong></p>
<h1 id="自定义资源">自定义资源</h1>
<h2 id="cr与crd">CR与CRD</h2>
<p>自定义资源（Custom Resource，CR），它是整个kubernetes生态中最核心的扩展机制。
<strong>自定的资源就和kubernetes自身的pod，deployment等一样，都是一等公民，都存放在etcd里。</strong>
kubernetes在1.7版本开始支持自定义资源功能。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">cnat.programming-kubernetes.info/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">At</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example-at</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedule</span>: <span style="color:#e6db74">&#34;2019-07-03T02:00:00Z&#34;</span>
</span></span></code></pre></div><blockquote>
<p>一个简单的CR</p>
</blockquote>
<p>现在很明显的一个问题是，kubernetes肯定不会认识我这个CR的，所以我们还需要一个Custom Resource Definition（CRD）来告诉kubernetes这些定义是什么含义。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apiextensions.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CustomResourceDefinition</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 名字必需与下面的 spec 字段匹配，并且格式为 &#39;&lt;名称的复数形式&gt;.&lt;组名&gt;&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ats.cnat.programming-kubernetes.info</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 组名称，用于 REST API: /apis/&lt;组&gt;/&lt;版本&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">cnat.programming-kubernetes.info</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 列举此 CustomResourceDefinition 所支持的版本</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">versions</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v1alpha1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># 每个版本都可以通过 served 标志来独立启用或禁止</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">served</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># 其中一个且只有一个版本必需被标记为存储版本</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">schema</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">openAPIV3Schema</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">schedule</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 可以是 Namespaced 或 Cluster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scope</span>: <span style="color:#ae81ff">Namespaced</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">names</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">At</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listKind</span>: <span style="color:#ae81ff">AtList</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">plural</span>: <span style="color:#ae81ff">ats</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">singular</span>: <span style="color:#ae81ff">at</span>
</span></span></code></pre></div><p>这个crd就是用来定义上面的cr的，其中schema是kubernetes提供的一种验证cr是否合法的机制。</p>
<p>现在，光有自定义资源是没有意义的，我们要在应用程序里感知到这些自定义资源，进而执行有实际意义的程序。在上面我们已经看到用client-go访问原生资源pod，那么怎么访问自定义资源呢？</p>
<h2 id="在程序中使用自定义资源">在程序中使用自定义资源</h2>
<p>常用的用来访问自定义资源的客户端有以下几种</p>
<ul>
<li>client-go的动态类型客户端</li>
<li>强类型客户端
<ul>
<li>kubernetes-sigs/controller-runtime 提供的客户端，Operator SDK 和 kuberbuilder中使用的这种。</li>
<li>client-gen生成的客户端，与k8s.io/client-go/kubernetes中使用的一样。</li>
</ul>
</li>
</ul>
<h3 id="client-go动态客户端">client-go动态客户端</h3>
<p>这种客户端对类型完全无感知，它的输出本质上就是json.Unmarshal的一个封装，下面代码用动态客户端获得了集群中的一个CR。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/dynamic&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/rest&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAMESPACE</span> = <span style="color:#e6db74">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAME</span> = <span style="color:#e6db74">&#34;foo&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">Config</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">env</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;KUBECONFIG&#34;</span>); len(<span style="color:#a6e22e">env</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">inClusterConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">InClusterConfig</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">inClusterConfig</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">kubeconfig</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;kubeconfig&#34;</span>, <span style="color:#e6db74">&#34;~/.kube/config&#34;</span>, <span style="color:#e6db74">&#34;kubeconfig file&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flagConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientcmd</span>.<span style="color:#a6e22e">BuildConfigFromFlags</span>(<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">kubeconfig</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">flagConfig</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">AcceptContentTypes</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf,application/json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ContentType</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dynamic</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">config</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">atGVR</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupVersionResource</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Group</span>:    <span style="color:#e6db74">&#34;cnat.programming-kubernetes.info&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Version</span>:  <span style="color:#e6db74">&#34;v1alpha1&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Resource</span>: <span style="color:#e6db74">&#34;ats&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">at</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Resource</span>(<span style="color:#a6e22e">atGVR</span>).<span style="color:#a6e22e">Namespace</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#e6db74">&#34;example-at&#34;</span>, <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">GetOptions</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">at</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>动态类型客户端失去了方便性，获得了通用性，不需要在编译器就确定我要对哪种资源生效，一般用在垃圾回收控制器，不需要复杂的逻辑，只删除各种父对象已经不存在的子对象。</strong></p>
<h3 id="强类型客户端">强类型客户端</h3>
<p>强类型客户端不使用通用的数据结构，而是为每种GVK创建专用的Go语言类型，这样的客户端需要通过工具生成。kubernetes官方的客户端不仅支持强类型客户端，也有一些其他的功能，下面详细介绍这种工具。</p>
<h1 id="k8siocode-generator">k8s.io/code-generator</h1>
<p>code-generator提供了一组可以在外部使用的代码生成器，通过调用代码包中的generate-group.sh脚本，就可以为我们生成包括强类型客户端以及其他代码。使用它的前提是，我们要用复合生成器语法的方式，定义我们要生成的内容。</p>
<p>生成操作自定义资源的客户端需要以下四个部分，都是上面文章中提到过的。</p>
<ul>
<li>deepcopy-gen: 生成深拷贝方法，所有的kubernetes对象都支持深拷贝，自定义的当然也要支持。</li>
<li>client-gen: 生成强类型的客户端。</li>
<li>informer-gen: 生成自定义资源的informer。</li>
<li>lister-gen: 生成lister对象，能够查询informer中缓存的资源对象。</li>
</ul>
<p>这些生成的代码和kubernetes原生控制器的代码逻辑一致，是能够用于生产级别的可靠的实践。</p>
<h2 id="生成器语法">生成器语法</h2>
<p>要使用生成器，就要遵循生成器的语法。</p>
<p>+&lt;tag_name&gt;[=value]格式的注释，就是 Kubernetes 进行代码生成要用的 Annotation 风格的注释</p>
<p>作为生成器的原材料，基本代码结构如下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>solar@solardeMacBook-Air kubernetesapi % tree pkg
</span></span><span style="display:flex;"><span>pkg
</span></span><span style="display:flex;"><span>└── apis
</span></span><span style="display:flex;"><span>    └── cnat
</span></span><span style="display:flex;"><span>        ├── register.go
</span></span><span style="display:flex;"><span>        └── v1alpha1
</span></span><span style="display:flex;"><span>            ├── doc.go
</span></span><span style="display:flex;"><span>            ├── register.go
</span></span><span style="display:flex;"><span>            └── types.go
</span></span></code></pre></div><p>其中pkg/apis/cnat/register.go里面用于存放全局变量。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">cnat</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GroupName</span> = <span style="color:#e6db74">&#34;cnat.programming-kubernetes.info&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Version</span>   = <span style="color:#e6db74">&#34;v1alpha1&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>pkg/apis/cnat/v1alpha1/ 目录下的三个文件，doc.go用于定义这个版本下的全局的生成器标签。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// +k8s:deepcopy-gen=package
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// +groupName=cnat.programming-kubernetes.info
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Package v1alpha1 is the v1alpha1 version of the API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">v1alpha1</span>
</span></span></code></pre></div><p>types.go 用于定义你的自定义类型。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">v1alpha1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// +genclient
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">PhasePending</span> = <span style="color:#e6db74">&#34;PENDING&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">PhaseRunning</span> = <span style="color:#e6db74">&#34;RUNNING&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">PhaseDone</span>    = <span style="color:#e6db74">&#34;DONE&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// AtSpec defines the desired state of At
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AtSpec</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Schedule is the desired time the command is supposed to be executed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Note: the format used here is UTC time https://www.utctime.net
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Schedule</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;schedule,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// AtStatus defines the observed state of At
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AtStatus</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Phase represents the state of the schedule: until the command is executed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// it is PENDING, afterwards it is DONE.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Phase</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;phase,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// +genclient
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// At runs a command at a given schedule.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">At</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span>   <span style="color:#e6db74">`json:&#34;,inline&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span> <span style="color:#e6db74">`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Spec</span>   <span style="color:#a6e22e">AtSpec</span>   <span style="color:#e6db74">`json:&#34;spec,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Status</span> <span style="color:#a6e22e">AtStatus</span> <span style="color:#e6db74">`json:&#34;status,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// AtList contains a list of At
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AtList</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span> <span style="color:#e6db74">`json:&#34;,inline&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListMeta</span> <span style="color:#e6db74">`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Items</span>           []<span style="color:#a6e22e">At</span> <span style="color:#e6db74">`json:&#34;items&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>register.go用于把类型注册到客户端，核心就是addKnowTypes函数，它是非常固定的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">v1alpha1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;kubernetesapi/pkg/apis/cnat&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SchemeGroupVersion is group version used to register these objects
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">SchemeGroupVersion</span> = <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupVersion</span>{<span style="color:#a6e22e">Group</span>: <span style="color:#a6e22e">cnat</span>.<span style="color:#a6e22e">GroupName</span>, <span style="color:#a6e22e">Version</span>: <span style="color:#a6e22e">cnat</span>.<span style="color:#a6e22e">Version</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Kind takes an unqualified kind and returns back a Group qualified GroupKind
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Kind</span>(<span style="color:#a6e22e">kind</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupKind</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">SchemeGroupVersion</span>.<span style="color:#a6e22e">WithKind</span>(<span style="color:#a6e22e">kind</span>).<span style="color:#a6e22e">GroupKind</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Resource takes an unqualified resource and returns a Group qualified GroupResource
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Resource</span>(<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupResource</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">SchemeGroupVersion</span>.<span style="color:#a6e22e">WithResource</span>(<span style="color:#a6e22e">resource</span>).<span style="color:#a6e22e">GroupResource</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SchemeBuilder</span> = <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">NewSchemeBuilder</span>(<span style="color:#a6e22e">addKnownTypes</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">AddToScheme</span>   = <span style="color:#a6e22e">SchemeBuilder</span>.<span style="color:#a6e22e">AddToScheme</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Adds the list of known types to Scheme.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">addKnownTypes</span>(<span style="color:#a6e22e">scheme</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Scheme</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">scheme</span>.<span style="color:#a6e22e">AddKnownTypes</span>(<span style="color:#a6e22e">SchemeGroupVersion</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">At</span>{},
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">AtList</span>{},
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">AddToGroupVersion</span>(<span style="color:#a6e22e">scheme</span>, <span style="color:#a6e22e">SchemeGroupVersion</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>下面解释一下上面代码中出现的生成器注释</p>
<ul>
<li>// +k8s:deepcopy-gen=package
<ul>
<li>为这个自定义类型创建深拷贝方法，这是每个类型都必须要有的，一般放在doc.go文件里作为全局的注释标签。</li>
</ul>
</li>
<li>// +groupName=cnat.programming-kubernetes.info
<ul>
<li>groupName和crd里的group保持一致，一般放在doc.go文件里作为全局的注释标签。</li>
</ul>
</li>
<li>// +genclient
<ul>
<li>这个注释表示会为该类型生成强类型的cilentSet 以及 informer和lister。</li>
</ul>
</li>
<li>// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
<ul>
<li>它的意思是，请在生成 DeepCopy 的时候，实现 Kubernetes 提供的 runtime.Object 接口。否则，在某些版本的 Kubernetes 里，你的这个类型定义会出现编译错误。这是一个固定的操作，记住即可。</li>
</ul>
</li>
</ul>
<p>最后通过代码生成工具，就得到了一个自定义类型的cientSet、informer、lister。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>generate-groups.sh &lt;generators&gt; &lt;output-package&gt; &lt;apis-package&gt; &lt;groups-versions&gt;
</span></span></code></pre></div><h1 id="自定义控制器">自定义控制器</h1>
<div align="center">
<img src="/custom-controller.png" height="40%" width="40%"></img>
<blockquote>
<p>custom controller</p>
</blockquote>
</div>
<p>上图就是一个自定义控制器的全貌，实际上左半部分我们已经多次提到了，kubenetes 的api服务和 informer，其中informer可以用client-go构建，对于自定义类型也可以使用k8s.io/code-generator构建。</p>
<p>有了informer，我们就有了一块缓存，里面保存的是我们想要的kubernetes资源，并且可以监听它的变化。这里的变化一般都是用户修改了资源的spec字段，这是资源的期望状态，期望状态有了变化之后该怎么办呢，就是图中右半部分要做的事。</p>
<p><strong>controller自己有一个工作队列，informer会把需要处理的资源对象放到队列里，controller每次从队列里取出资源都会检查他的实际状态（通过监控系统）与期望状态是否相符，如果相符就不需要操作，也不用再放回队列里。如果不相符，那么控制器需要进行调谐，改变实际状态，如果改变成功，就更新资源的status，同时不用再放回队列里了，如果改变失败还要放回队列里，等待下轮循环继续处理。</strong></p>
<h1 id="operator">Operator</h1>
<p><strong>Operator实际上就是上面讲到的自定义资源(CR)自定义资源的定义(CRD)和用户的自定义控制器的一个总称，再细分一下就是CR+CRD+informer+workQueue+ContorllerLoop。</strong></p>
<p>实际工作中，我们通常使用kubebuilder或者operator SDK来编写operator。本文会介绍kubebuilder的核心用法。</p>
<h2 id="使用kubebuilder">使用kubebuilder</h2>
<p>因为用到了go mod，使用kubebuilder前需要先初始化一个go mod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">go</span> <span style="color:#a6e22e">mod</span> <span style="color:#a6e22e">init</span> <span style="color:#a6e22e">my</span>.<span style="color:#a6e22e">domain</span>
</span></span></code></pre></div><p>然后使用kubebuilder初始化项目。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubebuilder init my.domain
</span></span></code></pre></div><p>创建api，这一步会帮我们创建好controller的框架和resource，同时定义好了资源的GVK。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubebuilder create api --group webapp --version v1 --kind Guestbook
</span></span></code></pre></div><p>此时在config/crd/当中crd的生成模版就已经创建好了，config/samples/里有一个对应的CR可供测试。并且对于这个CR的informer和workQueue、controllerLoop的框架都已经搭建好了，需要我们修改的是api/v1/guestbook_types.go和controllers/guestbook_controller.go，这两个文件定义的分别是我的资源有那些信息，以及如何调谐。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GuestbookReconciler</span>) <span style="color:#a6e22e">Reconcile</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">FromContext</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">instance</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">webappv1</span>.<span style="color:#a6e22e">Guestbook</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">NamespacedName</span>, <span style="color:#a6e22e">instance</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsNotFound</span>(<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Request object not found, could have been deleted after reconcile request - return and don&#39;t requeue:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reconcile</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Error reading the object - requeue the request:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reconcile</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		get instance real status by monitoring
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Update the At instance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Status</span>().<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">instance</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这个方法就是用来实现调谐逻辑的，其中req就是从workQueue中取出来的待处理的对象，只包含了了name和Namespace，所以我们还需要去informer的缓存中拿出完整的定义来，然后查看资源的实际状态。</p>
<p><strong>其中从workQueue里取出待调谐对象后去informer查最新情况也体现了kubernetes只关心最终状态的设计特点，另外对于notfound的err要忽略，因为它无法通过重试解决。</strong></p>
<p>kubebuilder生成的makefile文件里，还定义了如何打包部署的脚本，具体使用可以参考官方文档。</p>
<h3 id="准入-webhooks">准入 Webhooks</h3>
<p>准入 webhook 是 HTTP 的回调，它可以接受准入请求，处理它们并且返回准入响应。</p>
<p>Kubernetes 提供了下面几种类型的准入 webhook：</p>
<ul>
<li><strong>变更准入 Webhook</strong> 这种类型的 webhook 会在对象创建或是更新且没有存储前改变操作对象，然后才存储。它可以用于资源请求中的默认字段，比如在 Deployment 中没有被用户制定的字段。它可以用于注入 sidecar 容器。</li>
<li><strong>验证准入 Webhook</strong> 这种类型的 webhook 会在对象创建或是更新且没有存储前验证操作对象，然后才存储。它可以有比纯基于 schema 验证更加复杂的验证。比如：交叉字段验证和 pod 镜像白名单。</li>
</ul>
<p>利用kubebuilder实现这两个webhook非常容易。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubebuilder create webhook --group webapp --version v1 --kind Guestbook --defaulting --programmatic-validation
</span></span></code></pre></div><p>其中参数&ndash;defaulting &ndash;programmatic-validation代表我们需要上述两种webhook。命令执行成功后会在api/v1目录下找到对应的webhook文件，其中Default()方法用来修改api对象，比如注入一些默认值。另外还有3个Validate方法，分别对api对象的创建、修改、删除动作进行拦截，检测字段是否合法，这里可以实现比crd中的schema更为完善的检测机制。</p></section>

  
  
  <footer class="mt-12 flex flex-wrap">
     
    <a
      class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]"
      href="/tags/kubernetes"
      >kubernetes</a
    >
     
    <a
      class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]"
      href="/tags/cloud-native"
      >cloud-native</a
    >
     
    <a
      class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]"
      href="/tags/golang"
      >golang</a
    >
    
  </footer>
  

  
  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a
      class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="/post/posts/dns/"
      ><span class="mr-1.5">←</span><span>DNS解析错了、不够智能、解析慢该怎么解决？</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="/post/posts/grpc/"
      ><span>grpc</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  
  

  
  

  
  

  
  
</article>


    </main>

    <footer
  class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"
>
  <div class="mr-auto">
    &copy; 2023
    <a class="link" href="/">Paper</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >Powered by Hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >✎ Paper</a
  >
</footer>

  </body>
</html>
