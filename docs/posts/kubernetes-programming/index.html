<!doctype html>































<html
  class="not-ready lg:text-base"
  style="--bg: #faf8f1"
  lang="en"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>æ€ä¹ˆå¼€å‘äº‘åŸç”Ÿåº”ç”¨ï¼Ÿ - ğŸ¶</title>

  
  <meta name="theme-color" />

  
  
  
  
  <meta name="description" content="å¦‚æœä½ æƒ³è®©ä½ çš„åº”ç”¨å……åˆ†åˆ©ç”¨kubernetesæä¾›çš„èƒ½åŠ›ï¼Œæœ¬æ–‡å°†æä¾›ä¸€äº›æ€è·¯å’Œä»£ç ç¤ºä¾‹ã€‚" />
  <meta name="author" content="Liu Zhe" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="/main.min.css" />

  
  
  
  
  
  <link rel="preload" as="image" href="/theme.png" />

  
  
  
  
  

  
  
  <link rel="preload" as="image" href="/github.svg" />
  
  

  
  
  <script
    defer
    src="/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  
  

  
  <link rel="icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.104.3" />

  
  
  
  
  
  <meta itemprop="name" content="æ€ä¹ˆå¼€å‘äº‘åŸç”Ÿåº”ç”¨ï¼Ÿ">
<meta itemprop="description" content="å¦‚æœä½ æƒ³è®©ä½ çš„åº”ç”¨å……åˆ†åˆ©ç”¨kubernetesæä¾›çš„èƒ½åŠ›ï¼Œæœ¬æ–‡å°†æä¾›ä¸€äº›æ€è·¯å’Œä»£ç ç¤ºä¾‹ã€‚"><meta itemprop="datePublished" content="2022-02-19T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-02-19T00:00:00+00:00" />
<meta itemprop="wordCount" content="1411">
<meta itemprop="keywords" content="kubernetes,cloud-native,golang," />
  
  <meta property="og:title" content="æ€ä¹ˆå¼€å‘äº‘åŸç”Ÿåº”ç”¨ï¼Ÿ" />
<meta property="og:description" content="å¦‚æœä½ æƒ³è®©ä½ çš„åº”ç”¨å……åˆ†åˆ©ç”¨kubernetesæä¾›çš„èƒ½åŠ›ï¼Œæœ¬æ–‡å°†æä¾›ä¸€äº›æ€è·¯å’Œä»£ç ç¤ºä¾‹ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/kubernetes-programming/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-19T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-02-19T00:00:00+00:00" />


  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="æ€ä¹ˆå¼€å‘äº‘åŸç”Ÿåº”ç”¨ï¼Ÿ"/>
<meta name="twitter:description" content="å¦‚æœä½ æƒ³è®©ä½ çš„åº”ç”¨å……åˆ†åˆ©ç”¨kubernetesæä¾›çš„èƒ½åŠ›ï¼Œæœ¬æ–‡å°†æä¾›ä¸€äº›æ€è·¯å’Œä»£ç ç¤ºä¾‹ã€‚"/>

  
  
  
  <link rel="canonical" href="/posts/kubernetes-programming/" />
  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a
      class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold"
      href="/"
      >ğŸ¶</a
    >
    <div
      class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  

  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#faf8f1'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    
    <nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6">
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/about/"
        >About</a
      >
      
    </nav>
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href="https://github.com/liuzhe7"
        target="_blank"
        rel="me"
      >
        github
      </a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"
    >
      

<article>
  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">æ€ä¹ˆå¼€å‘äº‘åŸç”Ÿåº”ç”¨ï¼Ÿ</h1>

    
    <div class="text-sm antialiased opacity-60">
      
      <time>Feb 19, 2022</time>
      
      
      
      
    </div>
    
  </header>

  <section><p>å¦‚æœä½ æƒ³è®©ä½ çš„åº”ç”¨å……åˆ†åˆ©ç”¨kubernetesæä¾›çš„èƒ½åŠ›ï¼Œæœ¬æ–‡å°†æä¾›ä¸€äº›æ€è·¯å’Œä»£ç ç¤ºä¾‹ã€‚</p>
<ul>
<li><a href="#%E6%9C%AC%E6%96%87%E8%BE%83%E9%95%BF%E6%8A%8A%E9%87%8D%E8%A6%81%E7%BB%93%E8%AE%BA%E7%BD%AE%E9%A1%B6">æœ¬æ–‡è¾ƒé•¿ï¼ŒæŠŠé‡è¦ç»“è®ºç½®é¡¶</a></li>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8">ä»€ä¹ˆæ˜¯äº‘åŸç”Ÿåº”ç”¨</a></li>
<li><a href="#client-go">client-go</a>
<ul>
<li><a href="#%E4%B9%90%E8%A7%82%E5%B9%B6%E5%8F%91">ä¹è§‚å¹¶å‘</a></li>
<li><a href="#watch%E4%B8%8Einformer">watchä¸informer</a></li>
</ul>
</li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90">è‡ªå®šä¹‰èµ„æº</a>
<ul>
<li><a href="#cr%E4%B8%8Ecrd">CRä¸CRD</a></li>
<li><a href="#%E5%9C%A8%E7%A8%8B%E5%BA%8F%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90">åœ¨ç¨‹åºä¸­ä½¿ç”¨è‡ªå®šä¹‰èµ„æº</a>
<ul>
<li><a href="#client-go%E5%8A%A8%E6%80%81%E5%AE%A2%E6%88%B7%E7%AB%AF">client-goåŠ¨æ€å®¢æˆ·ç«¯</a></li>
<li><a href="#%E5%BC%BA%E7%B1%BB%E5%9E%8B%E5%AE%A2%E6%88%B7%E7%AB%AF">å¼ºç±»å‹å®¢æˆ·ç«¯</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#k8siocode-generator">k8s.io/code-generator</a>
<ul>
<li><a href="#%E7%94%9F%E6%88%90%E5%99%A8%E8%AF%AD%E6%B3%95">ç”Ÿæˆå™¨è¯­æ³•</a></li>
</ul>
</li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A7%E5%88%B6%E5%99%A8">è‡ªå®šä¹‰æ§åˆ¶å™¨</a></li>
<li><a href="#operator">Operator</a>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8kubebuilder">ä½¿ç”¨kubebuilder</a>
<ul>
<li><a href="#%E5%87%86%E5%85%A5-webhooks">å‡†å…¥ Webhooks</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="æœ¬æ–‡è¾ƒé•¿æŠŠé‡è¦ç»“è®ºç½®é¡¶">æœ¬æ–‡è¾ƒé•¿ï¼ŒæŠŠé‡è¦ç»“è®ºç½®é¡¶</h1>
<ul>
<li>
<p>å¦‚æœç¨‹åºè¿è¡Œåœ¨podé‡Œï¼Œkubeletä¼šè‡ªåŠ¨æŒ‚åœ¨ä¸€ä¸ªæœåŠ¡è´¦å·ï¼Œè·¯å¾„æ˜¯/var/run/secrets/kubernetes.io/serviceaccountï¼Œå®ƒå¯ä»¥æ›¿ä»£kubeconfigæ–‡ä»¶ã€‚client-goé‡Œçš„rest.InClusterConfig()ä¼šè‡ªåŠ¨å»è¿™ä¸ªç›®å½•ä¸‹æ‰¾ã€‚</p>
</li>
<li>
<p>è®¾ç½®config.ContentType = &ldquo;application/vnd.kubernetes.protobuf&rdquo; æ˜¯ä¸ºäº†è®©client-goä½¿ç”¨protobufç¼–ç è®¿é—®kubernetesï¼Œè¿™ç§æ ¼å¼æ¯”jsonæ›´åŠ è½»é‡å¿«é€Ÿï¼Œä½†æ˜¯è‡ªå®šä¹‰èµ„æºä¸æ”¯æŒã€‚</p>
</li>
<li>
<p>kubernetes çš„apiæœåŠ¡å¯¹äºä¸¤ä¸ªå¹¶å‘çš„å†™è¯·æ±‚ï¼Œä¼šæ‹’ç»åé¢ä¸€ä¸ªã€‚å¯¹äºpodæˆ–å…¶ä»–èµ„æºçš„å†™è¯·æ±‚ï¼Œå¯èƒ½æ¥è‡ªæˆ‘ä»¬è‡ªå·±çš„ä»£ç ä¹Ÿå¯èƒ½æ¥è‡ªkubeletæˆ–å…¶ä»–ç»„ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç›´å‡è®¾æˆ‘è¿™ä¸ªè¯·æ±‚å¯èƒ½æ˜¯ä¼šè¢«æ‹’ç»çš„ã€‚å½“ä¸€ä¸ªå¯¹è±¡çš„metadata.resourceVersionæ˜¯æœ€æ–°çš„å€¼ï¼Œæ›´æ–°æ‰èƒ½è¢«æ¥å—ã€‚</p>
</li>
<li>
<p>watchè¿‡ç¨‹ä¸­å¦‚æœå‘ç”Ÿäº†é”™è¯¯æˆ–è€…è°ƒç”¨äº†Stop()watchçš„channelä¼šè¢«å…³é—­ã€‚</p>
</li>
<li>
<p>AllowWatchBookmarksè®¾ç½®ä¸ºtrueï¼Œè¿™è¡¨ç¤ºæˆ‘ä»¬å¯ç”¨äº†bookmarkçš„èƒ½åŠ›ã€‚ä¸Šé¢è®²åˆ°çš„ä¹è§‚é”æœºåˆ¶ï¼Œkubernetesçš„apiåªæ¥å—å¯¹æœ€æ–°ç‰ˆæœ¬å¯¹è±¡çš„ä¿®æ”¹ï¼Œå¦‚æœæˆ‘çš„watchæ–­å¼€è¿æ¥é‡æ–°è¿æ¥åé”™è¿‡äº†å‡ ä¸ªeventå¯¼è‡´æˆ‘ç¼“å­˜çš„ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬å¯¹è±¡äº†ï¼Œé‚£ä¹ˆæˆ‘å°±è¦é‡æ–°listä¸€éæœ€æ–°çš„å¯¹è±¡ï¼Œä½†æ˜¯è¿™å¤ªæ¶ˆè€—èµ„æºäº†ï¼ŒBookmarkå°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Œæˆ‘åªä¼ resourceversionæå¤§çš„å‡å°‘äº†æ•°æ®ä¼ è¾“ï¼Œæ‹¿åˆ°æœ€æ–°çš„ç‰ˆæœ¬å·åï¼Œæˆ‘çš„æ›´æ–°è¯·æ±‚å°±åˆå¯ä»¥è¢«æ¥å—äº†ã€‚</p>
</li>
<li>
<p>åœ¨å®è·µä¸­æˆ‘ä»¬å¾€å¾€ä¸ç›´æ¥ä½¿ç”¨watchï¼Œå› ä¸ºclient-goè¿˜æœ‰informeræœºåˆ¶ï¼Œä»–å¯¹watchè¿›è¡Œäº†å°è£…ï¼Œæä¾›äº†ç¼“å­˜å¹¶åŠ ä»¥ç´¢å¼•æŸ¥è¯¢ã€‚å¹¶ä¸”ä»–èƒ½è‡ªåŠ¨å¤„ç†watch channelå…³é—­çš„æƒ…å†µã€‚informerå¸®æˆ‘ä»¬ä¿è¯äº†ä»–çš„ç¼“å­˜ä¸­å°±æ˜¯kubernetesé›†ç¾¤ä¸­å®é™…èµ„æºå¯¹è±¡çš„æœ€æ–°çŠ¶æ€ã€‚</p>
</li>
<li>
<p>å…±äº«informerå·¥å‚å…è®¸åº”ç”¨ä¸­ä¸åŒæ§åˆ¶å¾ªç¯å…±äº«ä¸€ä¸ªwatchè¿æ¥ï¼Œå¯ä»¥å‡å°‘ä¸kubernetesé€šä¿¡çš„å‹åŠ›ã€‚å…¶ä¸­defaultResyncä»£è¡¨æˆ‘ä»¬å¤šé•¿æ—¶é—´è¦å‘ kubernetes api è¿›è¡Œä¸€æ¬¡listã€‚</p>
</li>
<li>
<p>informerFactory.WaitForCacheSync(wait.NeverStop)è¡¨ç¤ºä»£ç è¦åœ¨è¿™é‡Œç­‰ç¬¬ä¸€æ¬¡listç»“æŸå†å¾€ä¸‹æ‰§è¡Œï¼Œè¿™å¯¹ä¾èµ–ç¼“å­˜å¡«å……å®Œæ¯•çš„åº”ç”¨å¾ˆé‡è¦ã€‚</p>
</li>
<li>
<p>åœ¨informerç¼“å­˜æœºåˆ¶ä¸‹ï¼Œæˆ‘ä»¬ä¸åº”è¯¥å»ä¿®æ”¹informerç¼“å­˜ä¸­çš„å¯¹è±¡ï¼Œè¿™ä¼šé€ æˆéš¾ä»¥æ’æŸ¥çš„é—®é¢˜ï¼Œä¸€å®šè¦æ·±æ‹·è´åå†ä¿®æ”¹ã€‚</p>
</li>
<li>
<p>è‡ªå®šçš„èµ„æºå°±å’Œkubernetesè‡ªèº«çš„podï¼Œdeploymentç­‰ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œéƒ½å­˜æ”¾åœ¨etcdé‡Œã€‚</p>
</li>
<li>
<p>åŠ¨æ€ç±»å‹å®¢æˆ·ç«¯å¤±å»äº†æ–¹ä¾¿æ€§ï¼Œè·å¾—äº†é€šç”¨æ€§ï¼Œä¸éœ€è¦åœ¨ç¼–è¯‘å™¨å°±ç¡®å®šæˆ‘è¦å¯¹å“ªç§èµ„æºç”Ÿæ•ˆï¼Œä¸€èˆ¬ç”¨åœ¨åƒåœ¾å›æ”¶æ§åˆ¶å™¨ï¼Œä¸éœ€è¦å¤æ‚çš„é€»è¾‘ï¼Œåªåˆ é™¤å„ç§çˆ¶å¯¹è±¡å·²ç»ä¸å­˜åœ¨çš„å­å¯¹è±¡ã€‚</p>
</li>
<li>
<p>controllerè‡ªå·±æœ‰ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ï¼Œinformerä¼šæŠŠéœ€è¦å¤„ç†çš„èµ„æºå¯¹è±¡æ”¾åˆ°é˜Ÿåˆ—é‡Œï¼Œcontrolleræ¯æ¬¡ä»é˜Ÿåˆ—é‡Œå–å‡ºèµ„æºéƒ½ä¼šæ£€æŸ¥ä»–çš„å®é™…çŠ¶æ€ï¼ˆé€šè¿‡ç›‘æ§ç³»ç»Ÿï¼‰ä¸æœŸæœ›çŠ¶æ€æ˜¯å¦ç›¸ç¬¦ï¼Œå¦‚æœç›¸ç¬¦å°±ä¸éœ€è¦æ“ä½œï¼Œä¹Ÿä¸ç”¨å†æ”¾å›é˜Ÿåˆ—é‡Œã€‚å¦‚æœä¸ç›¸ç¬¦ï¼Œé‚£ä¹ˆæ§åˆ¶å™¨éœ€è¦è¿›è¡Œè°ƒè°ï¼Œæ”¹å˜å®é™…çŠ¶æ€ï¼Œå¦‚æœæ”¹å˜æˆåŠŸï¼Œå°±æ›´æ–°èµ„æºçš„statusï¼ŒåŒæ—¶ä¸ç”¨å†æ”¾å›é˜Ÿåˆ—é‡Œäº†ï¼Œå¦‚æœæ”¹å˜å¤±è´¥è¿˜è¦æ”¾å›é˜Ÿåˆ—é‡Œï¼Œç­‰å¾…ä¸‹è½®å¾ªç¯ç»§ç»­å¤„ç†ã€‚</p>
</li>
<li>
<p>Operatorå®é™…ä¸Šå°±æ˜¯ä¸Šé¢è®²åˆ°çš„è‡ªå®šä¹‰èµ„æº(CR)è‡ªå®šä¹‰èµ„æºçš„å®šä¹‰(CRD)å’Œç”¨æˆ·çš„è‡ªå®šä¹‰æ§åˆ¶å™¨çš„ä¸€ä¸ªæ€»ç§°ï¼Œå†ç»†åˆ†ä¸€ä¸‹å°±æ˜¯CR+CRD+informer+workQueue+ContorllerLoopã€‚</p>
</li>
<li>
<p>contorller ä»workQueueé‡Œå–å‡ºå¾…è°ƒè°å¯¹è±¡åå»informeræŸ¥æœ€æ–°æƒ…å†µä¹Ÿä½“ç°äº†kubernetesåªå…³å¿ƒæœ€ç»ˆçŠ¶æ€çš„è®¾è®¡ç‰¹ç‚¹ï¼Œå¦å¤–å¯¹äºnotfoundçš„errè¦å¿½ç•¥ï¼Œå› ä¸ºå®ƒæ— æ³•é€šè¿‡é‡è¯•è§£å†³ã€‚</p>
</li>
<li>
<p>å‡†å…¥webhookæœ‰ä¸¤ç§ï¼Œéƒ½æ˜¯ä½œç”¨åœ¨èµ„æºè½åº“åˆ°etcdä¹‹å‰ã€‚ä¸€ä¸ªç”¨äºä¿®æ”¹apiå¯¹è±¡æ¯”å¦‚æ³¨å…¥é»˜è®¤å­—æ®µï¼Œå¦ä¸€ä¸ªç”¨äºéªŒè¯APIå¯¹è±¡çš„å„ä¸ªå­—æ®µæ˜¯å¦åˆæ³•ï¼Œè¿™æ¯”crdé‡Œçš„schemaçš„æ ¡éªŒæ›´åŠ çµæ´»ã€‚</p>
</li>
</ul>
<h1 id="ä»€ä¹ˆæ˜¯äº‘åŸç”Ÿåº”ç”¨">ä»€ä¹ˆæ˜¯äº‘åŸç”Ÿåº”ç”¨</h1>
<p>å¯¹äºéäº‘åŸç”Ÿåº”ç”¨ï¼Œå®ƒè®¾è®¡ä¹‹åˆä¸ä¼šè€ƒè™‘å°†æ¥è¦è¿è¡Œåœ¨kubernetesä¸Šï¼Œä¹Ÿè®¸å®ƒåªæ˜¯è¿è¡Œåœ¨è™šæ‹Ÿæœºï¼Œæˆ–è€…dockerï¼Œç°åœ¨è¿ç§»åˆ°äº†kubernetesé›†ç¾¤ä¸­ï¼Œè¢«kubernetesç®¡ç†ï¼Œä½†æ˜¯å®ƒæœ¬èº«å¹¶ä¸ä¼šå»è®¿é—®kubernetesçš„apiæœåŠ¡ã€‚</p>
<p>å¯¹äºäº‘åŸç”Ÿåº”ç”¨åˆ™ç›¸åï¼Œä»–è®¾è®¡ä¹‹åˆå°±æ˜¯è€ƒè™‘åˆ°è¦åˆ©ç”¨kubernetesçš„èƒ½åŠ›ï¼Œå®ƒä¼šè°ƒç”¨kubernetesçš„apiï¼Œå› æ­¤å¤§éƒ¨åˆ†æ—¶å€™å®ƒä¹Ÿåªèƒ½éƒ¨ç½²åœ¨kubernetesã€‚ä½†æ˜¯å¥½å¤„æ˜¯ï¼Œç°åœ¨äº‘æœåŠ¡å•†å¤§è§„æ¨¡çš„ä½¿ç”¨kubernetesï¼Œå› æ­¤å®ƒå¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨æœåŠ¡å•†ä¹‹é—´è¿ç§»ï¼Œå¹¶ä¸”kuberneteså£°æ˜å¼çš„æœºåˆ¶ï¼Œèƒ½å¸®æˆ‘æˆ‘ä»¬å®Œæˆä¸€äº›åº”ç”¨çš„è‡ªåŠ¨åŒ–è¿ç»´ã€‚</p>
<h1 id="client-go">client-go</h1>
<p>client-goæ˜¯ä¸€ä¸ªå…¸å‹çš„webæœåŠ¡å®¢æˆ·ç«¯ï¼Œå®ƒæ”¯æŒkubernetesä¸­æ‰€æœ‰å®˜æ–¹çš„APIç±»å‹ã€‚ä¸‹é¢ä»£ç ç”¨client-goåœ¨kubernetesé›†ç¾¤ä¸­å¯¹ä¸€ä¸ªpodè¿›è¡ŒCURDã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">corev1</span> <span style="color:#e6db74">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/rest&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAMESPACE</span> = <span style="color:#e6db74">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAME</span> = <span style="color:#e6db74">&#34;foo&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">Config</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">env</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;KUBECONFIG&#34;</span>); len(<span style="color:#a6e22e">env</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">inClusterConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">InClusterConfig</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">inClusterConfig</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">kubeconfig</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;kubeconfig&#34;</span>, <span style="color:#e6db74">&#34;~/.kube/config&#34;</span>, <span style="color:#e6db74">&#34;kubeconfig file&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flagConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientcmd</span>.<span style="color:#a6e22e">BuildConfigFromFlags</span>(<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">kubeconfig</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">flagConfig</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">AcceptContentTypes</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf,application/json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ContentType</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">clientSet</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">config</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pod</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Pod</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ObjectMeta</span>: <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">NAME</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Labels</span>: <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{
</span></span><span style="display:flex;"><span>				<span style="color:#e6db74">&#34;k&#34;</span>: <span style="color:#e6db74">&#34;v&#34;</span>,
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Spec</span>: <span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">PodSpec</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">Containers</span>: []<span style="color:#a6e22e">corev1</span>.<span style="color:#a6e22e">Container</span>{
</span></span><span style="display:flex;"><span>				{<span style="color:#a6e22e">Name</span>: <span style="color:#e6db74">&#34;busybox&#34;</span>, <span style="color:#a6e22e">Image</span>: <span style="color:#e6db74">&#34;busybox:latest&#34;</span>, <span style="color:#a6e22e">Command</span>: []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;sleep&#34;</span>, <span style="color:#e6db74">&#34;1000&#34;</span>}},
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">CreateOptions</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;create pods err:%s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">NAME</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">GetOptions</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;get pods err:%s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">ObjectMeta</span>.<span style="color:#a6e22e">Labels</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ticker</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">NewTicker</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">times</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ticker</span>.<span style="color:#a6e22e">Stop</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">ticker</span>.<span style="color:#a6e22e">C</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">NAME</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">GetOptions</span>{})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;get pods err:%s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">ObjectMeta</span>.<span style="color:#a6e22e">Labels</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;patch&#34;</span>: <span style="color:#e6db74">&#34;v1&#34;</span>}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">UpdateOptions</span>{})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;update pods err:%s\n&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">times</span> &gt; <span style="color:#ae81ff">3</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;we will try again in 3 second&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">times</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">NAME</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">GetOptions</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;get pods err:%s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">pod</span>.<span style="color:#a6e22e">ObjectMeta</span>.<span style="color:#a6e22e">Labels</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Delete</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">NAME</span>, <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">DeleteOptions</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;get pods err:%s&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>é¦–å…ˆè¦è¯»å–é›†ç¾¤çš„é…ç½®æ–‡ä»¶ï¼Œé‡Œé¢åŒ…å«äº†æœåŠ¡å™¨åç§°ï¼Œèº«ä»½è®¤è¯ä¿¡æ¯ç­‰å®¢æˆ·ç«¯æ•°æ®ã€‚
<strong>å¦‚æœç¨‹åºè¿è¡Œåœ¨podé‡Œï¼Œkubeletä¼šè‡ªåŠ¨æŒ‚åœ¨ä¸€ä¸ªæœåŠ¡è´¦å·ï¼Œè·¯å¾„æ˜¯/var/run/secrets/kubernetes.io/serviceaccountï¼Œå®ƒå¯ä»¥æ›¿ä»£kubeconfigæ–‡ä»¶ã€‚client-goé‡Œçš„rest.InClusterConfig()ä¼šè‡ªåŠ¨å»è¿™ä¸ªç›®å½•ä¸‹æ‰¾ã€‚</strong>
æ‰€ä»¥æˆ‘ä»¬é€šè¿‡ç¯å¢ƒå˜é‡åˆ¤æ–­æ˜¯å¦è¿è¡Œåœ¨å®¹å™¨ï¼Œç„¶ååˆ†åˆ«ç”¨ rest.InClusterConfig å’Œ clientcmd.BuildConfigFromFlags è·å–ä¸¤ç§åœºæ™¯ä¸‹çš„é…ç½®æ–‡ä»¶ã€‚<strong>è®¾ç½®config.ContentType = &ldquo;application/vnd.kubernetes.protobuf&rdquo; æ˜¯ä¸ºäº†è®©client-goä½¿ç”¨protobufç¼–ç è®¿é—®kubernetesï¼Œè¿™ç§æ ¼å¼æ¯”jsonæ›´åŠ è½»é‡å¿«é€Ÿï¼Œä½†æ˜¯è‡ªå®šä¹‰èµ„æºä¸æ”¯æŒã€‚</strong>
ç„¶ååˆå§‹åŒ–å®¢æˆ·ç«¯ï¼Œä¹‹åå®¢æˆ·ç«¯åˆ†åˆ«è¿›è¡Œäº†å¯¹podçš„CURDæ“ä½œã€‚</p>
<h2 id="ä¹è§‚å¹¶å‘">ä¹è§‚å¹¶å‘</h2>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå¯¹podè¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆgetäº†ä¸€æ¬¡é›†ç¾¤ä¸­çš„podï¼Œå¹¶ä¸”æ•´ä¸ªè¿‡ç¨‹æ”¾åœ¨äº†å¾ªç¯é‡Œã€‚è¿™æ˜¯å› ä¸ºkubernetesçš„apiæœåŠ¡é‡‡ç”¨çš„ä¹è§‚å¹¶å‘çš„æ¨¡å‹ã€‚<strong>kubernetes çš„apiæœåŠ¡å¯¹äºä¸¤ä¸ªå¹¶å‘çš„å†™è¯·æ±‚ï¼Œä¼šæ‹’ç»åé¢ä¸€ä¸ªã€‚å¯¹äºpodæˆ–å…¶ä»–èµ„æºçš„å†™è¯·æ±‚ï¼Œå¯èƒ½æ¥è‡ªæˆ‘ä»¬è‡ªå·±çš„ä»£ç ä¹Ÿå¯èƒ½æ¥è‡ªkubeletæˆ–å…¶ä»–ç»„ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç›´å‡è®¾æˆ‘è¿™ä¸ªè¯·æ±‚å¯èƒ½æ˜¯ä¼šè¢«æ‹’ç»çš„ã€‚å½“ä¸€ä¸ªå¯¹è±¡çš„metadata.resourceVersionæ˜¯æœ€æ–°çš„å€¼ï¼Œæ›´æ–°æ‰èƒ½è¢«æ¥å—ã€‚</strong></p>
<h2 id="watchä¸informer">watchä¸informer</h2>
<p>watch æä¾›äº†å‘ç°å¯¹è±¡å„ç§å˜åŒ–çš„æœºåˆ¶ï¼Œå¦‚æ·»åŠ ã€åˆ é™¤ã€æ›´æ–°ã€‚ä¸‹é¢ä»£ç å®ç°äº†å¯¹default namespaceå†… pod çš„watch</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v1</span> <span style="color:#e6db74">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/watch&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/rest&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAMESPACE</span> = <span style="color:#e6db74">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAME</span> = <span style="color:#e6db74">&#34;foo&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">Config</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">env</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;KUBECONFIG&#34;</span>); len(<span style="color:#a6e22e">env</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">inClusterConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">InClusterConfig</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">inClusterConfig</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">kubeconfig</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;kubeconfig&#34;</span>, <span style="color:#e6db74">&#34;~/.kube/config&#34;</span>, <span style="color:#e6db74">&#34;kubeconfig file&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flagConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientcmd</span>.<span style="color:#a6e22e">BuildConfigFromFlags</span>(<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">kubeconfig</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">flagConfig</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">AcceptContentTypes</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf,application/json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ContentType</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">clientSet</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">config</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">watcher</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientSet</span>.<span style="color:#a6e22e">CoreV1</span>().<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Watch</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListOptions</span>{<span style="color:#a6e22e">AllowWatchBookmarks</span>: <span style="color:#66d9ef">true</span>})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">event</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">watcher</span>.<span style="color:#a6e22e">ResultChan</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Type</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Added</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;added evnet from %s\n&#34;</span>, <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>).<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Modified</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;modified evnet from %s\n&#34;</span>, <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>).<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Deleted</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;deleted evnet from %s\n&#34;</span>, <span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">Object</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>).<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Bookmark</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;`Bookmark` means watch has synced here, just update the resourceVersion&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">watch</span>.<span style="color:#a6e22e">Error</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;unable to understand watch event%v\n&#34;</span>, <span style="color:#a6e22e">event</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;watcher channel closed&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>é¦–å…ˆé€šè¿‡clientSetåˆ›å»ºä¸€ä¸ª watch pod çš„ watcherï¼Œwatcher.ResultChan()ä¼šè¿”å›ä¸€ä¸ªåªèƒ½æ¥æ”¶çš„channelï¼Œæ‰€æœ‰è¢«watchåˆ°çš„äº‹ä»¶éƒ½ä¼šè¢«å‘é€åˆ°è¿™ä¸ªchannelä¸­ã€‚å…¶ä¸­æœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ã€‚</p>
<ul>
<li><strong>watchè¿‡ç¨‹ä¸­å¦‚æœå‘ç”Ÿäº†é”™è¯¯æˆ–è€…è°ƒç”¨äº†Stop()watchçš„channelä¼šè¢«å…³é—­ã€‚</strong></li>
<li><strong>AllowWatchBookmarksè®¾ç½®ä¸ºtrueï¼Œè¿™è¡¨ç¤ºæˆ‘ä»¬å¯ç”¨äº†bookmarkçš„èƒ½åŠ›ã€‚ä¸Šé¢è®²åˆ°çš„ä¹è§‚é”æœºåˆ¶ï¼Œkubernetesçš„apiåªæ¥å—å¯¹æœ€æ–°ç‰ˆæœ¬å¯¹è±¡çš„ä¿®æ”¹ï¼Œå¦‚æœæˆ‘çš„watchæ–­å¼€è¿æ¥é‡æ–°è¿æ¥åé”™è¿‡äº†å‡ ä¸ªeventå¯¼è‡´æˆ‘ç¼“å­˜çš„ä¸æ˜¯æœ€æ–°ç‰ˆæœ¬å¯¹è±¡äº†ï¼Œé‚£ä¹ˆæˆ‘å°±è¦é‡æ–°listä¸€éæœ€æ–°çš„å¯¹è±¡ï¼Œä½†æ˜¯è¿™å¤ªæ¶ˆè€—èµ„æºäº†ï¼ŒBookmarkå°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Œæˆ‘åªä¼ resourceversionæå¤§çš„å‡å°‘äº†æ•°æ®ä¼ è¾“ï¼Œæ‹¿åˆ°æœ€æ–°çš„ç‰ˆæœ¬å·åï¼Œæˆ‘çš„æ›´æ–°è¯·æ±‚å°±åˆå¯ä»¥è¢«æ¥å—äº†ã€‚</strong></li>
</ul>
<p><strong>åœ¨å®è·µä¸­æˆ‘ä»¬å¾€å¾€ä¸ç›´æ¥ä½¿ç”¨watchï¼Œå› ä¸ºclient-goè¿˜æœ‰informeræœºåˆ¶ï¼Œä»–å¯¹watchè¿›è¡Œäº†å°è£…ï¼Œæä¾›äº†ç¼“å­˜å¹¶åŠ ä»¥ç´¢å¼•æŸ¥è¯¢ã€‚å¹¶ä¸”ä»–èƒ½è‡ªåŠ¨å¤„ç†watch channelå…³é—­çš„æƒ…å†µã€‚informerå¸®æˆ‘ä»¬ä¿è¯äº†ä»–çš„ç¼“å­˜ä¸­å°±æ˜¯kubernetesé›†ç¾¤ä¸­å®é™…èµ„æºå¯¹è±¡çš„æœ€æ–°çŠ¶æ€ã€‚</strong></p>
<p>ä¸‹é¢ä»£ç å®ç°äº†ä¸€ä¸ªinformerã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v1</span> <span style="color:#e6db74">&#34;k8s.io/api/core/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/util/wait&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/informers&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/rest&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/tools/cache&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAMESPACE</span> = <span style="color:#e6db74">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAME</span> = <span style="color:#e6db74">&#34;foo&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">Config</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">env</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;KUBECONFIG&#34;</span>); len(<span style="color:#a6e22e">env</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">inClusterConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">InClusterConfig</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">inClusterConfig</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">kubeconfig</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;kubeconfig&#34;</span>, <span style="color:#e6db74">&#34;~/.kube/config&#34;</span>, <span style="color:#e6db74">&#34;kubeconfig file&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flagConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientcmd</span>.<span style="color:#a6e22e">BuildConfigFromFlags</span>(<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">kubeconfig</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">flagConfig</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">AcceptContentTypes</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf,application/json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ContentType</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">clientSet</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">kubernetes</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">config</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">informerFactory</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">informers</span>.<span style="color:#a6e22e">NewSharedInformerFactory</span>(<span style="color:#a6e22e">clientSet</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span><span style="color:#f92672">*</span><span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">podInformer</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">informerFactory</span>.<span style="color:#a6e22e">Core</span>().<span style="color:#a6e22e">V1</span>().<span style="color:#a6e22e">Pods</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">podInformer</span>.<span style="color:#a6e22e">Informer</span>().<span style="color:#a6e22e">AddEventHandler</span>(<span style="color:#a6e22e">cache</span>.<span style="color:#a6e22e">ResourceEventHandlerFuncs</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">AddFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;add pod :%s\n&#34;</span>, <span style="color:#a6e22e">obj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>).<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">UpdateFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">oldObj</span>, <span style="color:#a6e22e">newObj</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;update pod :%s\n&#34;</span>, <span style="color:#a6e22e">oldObj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>).<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">DeleteFunc</span>: <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">obj</span> <span style="color:#66d9ef">interface</span>{}) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;delete pod :%s\n&#34;</span>, <span style="color:#a6e22e">obj</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>).<span style="color:#a6e22e">Name</span>)
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">informerFactory</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NeverStop</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">informerFactory</span>.<span style="color:#a6e22e">WaitForCacheSync</span>(<span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NeverStop</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NeverStop</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>æˆ‘ä»¬ç”¨å…±äº«informerå·¥å‚åˆ›å»ºäº†ä¸€ä¸ªpodçš„informerï¼Œ<strong>å…±äº«informerå·¥å‚å…è®¸åº”ç”¨ä¸­ä¸åŒæ§åˆ¶å¾ªç¯å…±äº«ä¸€ä¸ªwatchè¿æ¥ï¼Œå¯ä»¥å‡å°‘ä¸kubernetesé€šä¿¡çš„å‹åŠ›ã€‚å…¶ä¸­defaultResyncä»£è¡¨æˆ‘ä»¬å¤šé•¿æ—¶é—´è¦å‘ kubernetes api è¿›è¡Œä¸€æ¬¡listã€‚</strong></p>
<p><strong>informerFactory.WaitForCacheSync(wait.NeverStop)è¡¨ç¤ºä»£ç è¦åœ¨è¿™é‡Œç­‰ç¬¬ä¸€æ¬¡listç»“æŸå†å¾€ä¸‹æ‰§è¡Œï¼Œè¿™å¯¹ä¾èµ–ç¼“å­˜å¡«å……å®Œæ¯•çš„åº”ç”¨å¾ˆé‡è¦ã€‚</strong></p>
<p><strong>åœ¨è¿™ç§ç¼“å­˜æœºåˆ¶ä¸‹ï¼Œæˆ‘ä»¬ä¸åº”è¯¥å»ä¿®æ”¹informerç¼“å­˜ä¸­çš„å¯¹è±¡ï¼Œè¿™ä¼šé€ æˆéš¾ä»¥æ’æŸ¥çš„é—®é¢˜ï¼Œä¸€å®šè¦æ·±æ‹·è´åå†ä¿®æ”¹ã€‚</strong></p>
<h1 id="è‡ªå®šä¹‰èµ„æº">è‡ªå®šä¹‰èµ„æº</h1>
<h2 id="crä¸crd">CRä¸CRD</h2>
<p>è‡ªå®šä¹‰èµ„æºï¼ˆCustom Resourceï¼ŒCRï¼‰ï¼Œå®ƒæ˜¯æ•´ä¸ªkubernetesç”Ÿæ€ä¸­æœ€æ ¸å¿ƒçš„æ‰©å±•æœºåˆ¶ã€‚
<strong>è‡ªå®šçš„èµ„æºå°±å’Œkubernetesè‡ªèº«çš„podï¼Œdeploymentç­‰ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œéƒ½å­˜æ”¾åœ¨etcdé‡Œã€‚</strong>
kubernetesåœ¨1.7ç‰ˆæœ¬å¼€å§‹æ”¯æŒè‡ªå®šä¹‰èµ„æºåŠŸèƒ½ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">cnat.programming-kubernetes.info/v1alpha1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">At</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">example-at</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedule</span>: <span style="color:#e6db74">&#34;2019-07-03T02:00:00Z&#34;</span>
</span></span></code></pre></div><blockquote>
<p>ä¸€ä¸ªç®€å•çš„CR</p>
</blockquote>
<p>ç°åœ¨å¾ˆæ˜æ˜¾çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œkubernetesè‚¯å®šä¸ä¼šè®¤è¯†æˆ‘è¿™ä¸ªCRçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªCustom Resource Definitionï¼ˆCRDï¼‰æ¥å‘Šè¯‰kubernetesè¿™äº›å®šä¹‰æ˜¯ä»€ä¹ˆå«ä¹‰ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apiextensions.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CustomResourceDefinition</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># åå­—å¿…éœ€ä¸ä¸‹é¢çš„ spec å­—æ®µåŒ¹é…ï¼Œå¹¶ä¸”æ ¼å¼ä¸º &#39;&lt;åç§°çš„å¤æ•°å½¢å¼&gt;.&lt;ç»„å&gt;&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ats.cnat.programming-kubernetes.info</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># ç»„åç§°ï¼Œç”¨äº REST API: /apis/&lt;ç»„&gt;/&lt;ç‰ˆæœ¬&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">group</span>: <span style="color:#ae81ff">cnat.programming-kubernetes.info</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># åˆ—ä¸¾æ­¤ CustomResourceDefinition æ‰€æ”¯æŒçš„ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">versions</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">v1alpha1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># æ¯ä¸ªç‰ˆæœ¬éƒ½å¯ä»¥é€šè¿‡ served æ ‡å¿—æ¥ç‹¬ç«‹å¯ç”¨æˆ–ç¦æ­¢</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">served</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># å…¶ä¸­ä¸€ä¸ªä¸”åªæœ‰ä¸€ä¸ªç‰ˆæœ¬å¿…éœ€è¢«æ ‡è®°ä¸ºå­˜å‚¨ç‰ˆæœ¬</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">schema</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">openAPIV3Schema</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">type</span>: <span style="color:#ae81ff">object</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">properties</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">schedule</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">string</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># å¯ä»¥æ˜¯ Namespaced æˆ– Cluster</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scope</span>: <span style="color:#ae81ff">Namespaced</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">names</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">At</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">listKind</span>: <span style="color:#ae81ff">AtList</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">plural</span>: <span style="color:#ae81ff">ats</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">singular</span>: <span style="color:#ae81ff">at</span>
</span></span></code></pre></div><p>è¿™ä¸ªcrdå°±æ˜¯ç”¨æ¥å®šä¹‰ä¸Šé¢çš„crçš„ï¼Œå…¶ä¸­schemaæ˜¯kubernetesæä¾›çš„ä¸€ç§éªŒè¯cræ˜¯å¦åˆæ³•çš„æœºåˆ¶ã€‚</p>
<p>ç°åœ¨ï¼Œå…‰æœ‰è‡ªå®šä¹‰èµ„æºæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæˆ‘ä»¬è¦åœ¨åº”ç”¨ç¨‹åºé‡Œæ„ŸçŸ¥åˆ°è¿™äº›è‡ªå®šä¹‰èµ„æºï¼Œè¿›è€Œæ‰§è¡Œæœ‰å®é™…æ„ä¹‰çš„ç¨‹åºã€‚åœ¨ä¸Šé¢æˆ‘ä»¬å·²ç»çœ‹åˆ°ç”¨client-goè®¿é—®åŸç”Ÿèµ„æºpodï¼Œé‚£ä¹ˆæ€ä¹ˆè®¿é—®è‡ªå®šä¹‰èµ„æºå‘¢ï¼Ÿ</p>
<h2 id="åœ¨ç¨‹åºä¸­ä½¿ç”¨è‡ªå®šä¹‰èµ„æº">åœ¨ç¨‹åºä¸­ä½¿ç”¨è‡ªå®šä¹‰èµ„æº</h2>
<p>å¸¸ç”¨çš„ç”¨æ¥è®¿é—®è‡ªå®šä¹‰èµ„æºçš„å®¢æˆ·ç«¯æœ‰ä»¥ä¸‹å‡ ç§</p>
<ul>
<li>client-goçš„åŠ¨æ€ç±»å‹å®¢æˆ·ç«¯</li>
<li>å¼ºç±»å‹å®¢æˆ·ç«¯
<ul>
<li>kubernetes-sigs/controller-runtime æä¾›çš„å®¢æˆ·ç«¯ï¼ŒOperator SDK å’Œ kuberbuilderä¸­ä½¿ç”¨çš„è¿™ç§ã€‚</li>
<li>client-genç”Ÿæˆçš„å®¢æˆ·ç«¯ï¼Œä¸k8s.io/client-go/kubernetesä¸­ä½¿ç”¨çš„ä¸€æ ·ã€‚</li>
</ul>
</li>
</ul>
<h3 id="client-goåŠ¨æ€å®¢æˆ·ç«¯">client-goåŠ¨æ€å®¢æˆ·ç«¯</h3>
<p>è¿™ç§å®¢æˆ·ç«¯å¯¹ç±»å‹å®Œå…¨æ— æ„ŸçŸ¥ï¼Œå®ƒçš„è¾“å‡ºæœ¬è´¨ä¸Šå°±æ˜¯json.Unmarshalçš„ä¸€ä¸ªå°è£…ï¼Œä¸‹é¢ä»£ç ç”¨åŠ¨æ€å®¢æˆ·ç«¯è·å¾—äº†é›†ç¾¤ä¸­çš„ä¸€ä¸ªCRã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">v1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/dynamic&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/rest&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAMESPACE</span> = <span style="color:#e6db74">&#34;default&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NAME</span> = <span style="color:#e6db74">&#34;foo&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">config</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">Config</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">env</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;KUBECONFIG&#34;</span>); len(<span style="color:#a6e22e">env</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">inClusterConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">rest</span>.<span style="color:#a6e22e">InClusterConfig</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">inClusterConfig</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">kubeconfig</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;kubeconfig&#34;</span>, <span style="color:#e6db74">&#34;~/.kube/config&#34;</span>, <span style="color:#e6db74">&#34;kubeconfig file&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flag</span>.<span style="color:#a6e22e">Parse</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flagConfig</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">clientcmd</span>.<span style="color:#a6e22e">BuildConfigFromFlags</span>(<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">kubeconfig</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">flagConfig</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">AcceptContentTypes</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf,application/json&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ContentType</span> = <span style="color:#e6db74">&#34;application/vnd.kubernetes.protobuf&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dynamic</span>.<span style="color:#a6e22e">NewForConfig</span>(<span style="color:#a6e22e">config</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">atGVR</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupVersionResource</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Group</span>:    <span style="color:#e6db74">&#34;cnat.programming-kubernetes.info&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Version</span>:  <span style="color:#e6db74">&#34;v1alpha1&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Resource</span>: <span style="color:#e6db74">&#34;ats&#34;</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">at</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Resource</span>(<span style="color:#a6e22e">atGVR</span>).<span style="color:#a6e22e">Namespace</span>(<span style="color:#a6e22e">NAMESPACE</span>).<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#e6db74">&#34;example-at&#34;</span>, <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">GetOptions</span>{})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">at</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>åŠ¨æ€ç±»å‹å®¢æˆ·ç«¯å¤±å»äº†æ–¹ä¾¿æ€§ï¼Œè·å¾—äº†é€šç”¨æ€§ï¼Œä¸éœ€è¦åœ¨ç¼–è¯‘å™¨å°±ç¡®å®šæˆ‘è¦å¯¹å“ªç§èµ„æºç”Ÿæ•ˆï¼Œä¸€èˆ¬ç”¨åœ¨åƒåœ¾å›æ”¶æ§åˆ¶å™¨ï¼Œä¸éœ€è¦å¤æ‚çš„é€»è¾‘ï¼Œåªåˆ é™¤å„ç§çˆ¶å¯¹è±¡å·²ç»ä¸å­˜åœ¨çš„å­å¯¹è±¡ã€‚</strong></p>
<h3 id="å¼ºç±»å‹å®¢æˆ·ç«¯">å¼ºç±»å‹å®¢æˆ·ç«¯</h3>
<p>å¼ºç±»å‹å®¢æˆ·ç«¯ä¸ä½¿ç”¨é€šç”¨çš„æ•°æ®ç»“æ„ï¼Œè€Œæ˜¯ä¸ºæ¯ç§GVKåˆ›å»ºä¸“ç”¨çš„Goè¯­è¨€ç±»å‹ï¼Œè¿™æ ·çš„å®¢æˆ·ç«¯éœ€è¦é€šè¿‡å·¥å…·ç”Ÿæˆã€‚kuberneteså®˜æ–¹çš„å®¢æˆ·ç«¯ä¸ä»…æ”¯æŒå¼ºç±»å‹å®¢æˆ·ç«¯ï¼Œä¹Ÿæœ‰ä¸€äº›å…¶ä»–çš„åŠŸèƒ½ï¼Œä¸‹é¢è¯¦ç»†ä»‹ç»è¿™ç§å·¥å…·ã€‚</p>
<h1 id="k8siocode-generator">k8s.io/code-generator</h1>
<p>code-generatoræä¾›äº†ä¸€ç»„å¯ä»¥åœ¨å¤–éƒ¨ä½¿ç”¨çš„ä»£ç ç”Ÿæˆå™¨ï¼Œé€šè¿‡è°ƒç”¨ä»£ç åŒ…ä¸­çš„generate-group.shè„šæœ¬ï¼Œå°±å¯ä»¥ä¸ºæˆ‘ä»¬ç”ŸæˆåŒ…æ‹¬å¼ºç±»å‹å®¢æˆ·ç«¯ä»¥åŠå…¶ä»–ä»£ç ã€‚ä½¿ç”¨å®ƒçš„å‰ææ˜¯ï¼Œæˆ‘ä»¬è¦ç”¨å¤åˆç”Ÿæˆå™¨è¯­æ³•çš„æ–¹å¼ï¼Œå®šä¹‰æˆ‘ä»¬è¦ç”Ÿæˆçš„å†…å®¹ã€‚</p>
<p>ç”Ÿæˆæ“ä½œè‡ªå®šä¹‰èµ„æºçš„å®¢æˆ·ç«¯éœ€è¦ä»¥ä¸‹å››ä¸ªéƒ¨åˆ†ï¼Œéƒ½æ˜¯ä¸Šé¢æ–‡ç« ä¸­æåˆ°è¿‡çš„ã€‚</p>
<ul>
<li>deepcopy-gen: ç”Ÿæˆæ·±æ‹·è´æ–¹æ³•ï¼Œæ‰€æœ‰çš„kuberneteså¯¹è±¡éƒ½æ”¯æŒæ·±æ‹·è´ï¼Œè‡ªå®šä¹‰çš„å½“ç„¶ä¹Ÿè¦æ”¯æŒã€‚</li>
<li>client-gen: ç”Ÿæˆå¼ºç±»å‹çš„å®¢æˆ·ç«¯ã€‚</li>
<li>informer-gen: ç”Ÿæˆè‡ªå®šä¹‰èµ„æºçš„informerã€‚</li>
<li>lister-gen: ç”Ÿæˆlisterå¯¹è±¡ï¼Œèƒ½å¤ŸæŸ¥è¯¢informerä¸­ç¼“å­˜çš„èµ„æºå¯¹è±¡ã€‚</li>
</ul>
<p>è¿™äº›ç”Ÿæˆçš„ä»£ç å’ŒkubernetesåŸç”Ÿæ§åˆ¶å™¨çš„ä»£ç é€»è¾‘ä¸€è‡´ï¼Œæ˜¯èƒ½å¤Ÿç”¨äºç”Ÿäº§çº§åˆ«çš„å¯é çš„å®è·µã€‚</p>
<h2 id="ç”Ÿæˆå™¨è¯­æ³•">ç”Ÿæˆå™¨è¯­æ³•</h2>
<p>è¦ä½¿ç”¨ç”Ÿæˆå™¨ï¼Œå°±è¦éµå¾ªç”Ÿæˆå™¨çš„è¯­æ³•ã€‚</p>
<p>+&lt;tag_name&gt;[=value]æ ¼å¼çš„æ³¨é‡Šï¼Œå°±æ˜¯ Kubernetes è¿›è¡Œä»£ç ç”Ÿæˆè¦ç”¨çš„ Annotation é£æ ¼çš„æ³¨é‡Š</p>
<p>ä½œä¸ºç”Ÿæˆå™¨çš„åŸææ–™ï¼ŒåŸºæœ¬ä»£ç ç»“æ„å¦‚ä¸‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>solar@solardeMacBook-Air kubernetesapi % tree pkg
</span></span><span style="display:flex;"><span>pkg
</span></span><span style="display:flex;"><span>â””â”€â”€ apis
</span></span><span style="display:flex;"><span>    â””â”€â”€ cnat
</span></span><span style="display:flex;"><span>        â”œâ”€â”€ register.go
</span></span><span style="display:flex;"><span>        â””â”€â”€ v1alpha1
</span></span><span style="display:flex;"><span>            â”œâ”€â”€ doc.go
</span></span><span style="display:flex;"><span>            â”œâ”€â”€ register.go
</span></span><span style="display:flex;"><span>            â””â”€â”€ types.go
</span></span></code></pre></div><p>å…¶ä¸­pkg/apis/cnat/register.goé‡Œé¢ç”¨äºå­˜æ”¾å…¨å±€å˜é‡ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">cnat</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">GroupName</span> = <span style="color:#e6db74">&#34;cnat.programming-kubernetes.info&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Version</span>   = <span style="color:#e6db74">&#34;v1alpha1&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>pkg/apis/cnat/v1alpha1/ ç›®å½•ä¸‹çš„ä¸‰ä¸ªæ–‡ä»¶ï¼Œdoc.goç”¨äºå®šä¹‰è¿™ä¸ªç‰ˆæœ¬ä¸‹çš„å…¨å±€çš„ç”Ÿæˆå™¨æ ‡ç­¾ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// +k8s:deepcopy-gen=package
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// +groupName=cnat.programming-kubernetes.info
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Package v1alpha1 is the v1alpha1 version of the API.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">v1alpha1</span>
</span></span></code></pre></div><p>types.go ç”¨äºå®šä¹‰ä½ çš„è‡ªå®šä¹‰ç±»å‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">v1alpha1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// +genclient
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">PhasePending</span> = <span style="color:#e6db74">&#34;PENDING&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">PhaseRunning</span> = <span style="color:#e6db74">&#34;RUNNING&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">PhaseDone</span>    = <span style="color:#e6db74">&#34;DONE&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// AtSpec defines the desired state of At
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AtSpec</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Schedule is the desired time the command is supposed to be executed.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// Note: the format used here is UTC time https://www.utctime.net
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Schedule</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;schedule,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// AtStatus defines the observed state of At
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AtStatus</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Phase represents the state of the schedule: until the command is executed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// it is PENDING, afterwards it is DONE.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Phase</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;phase,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Important: Run &#34;make&#34; to regenerate code after modifying this file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// +genclient
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// At runs a command at a given schedule.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">At</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span>   <span style="color:#e6db74">`json:&#34;,inline&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ObjectMeta</span> <span style="color:#e6db74">`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Spec</span>   <span style="color:#a6e22e">AtSpec</span>   <span style="color:#e6db74">`json:&#34;spec,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Status</span> <span style="color:#a6e22e">AtStatus</span> <span style="color:#e6db74">`json:&#34;status,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// AtList contains a list of At
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AtList</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">TypeMeta</span> <span style="color:#e6db74">`json:&#34;,inline&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">ListMeta</span> <span style="color:#e6db74">`json:&#34;metadata,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Items</span>           []<span style="color:#a6e22e">At</span> <span style="color:#e6db74">`json:&#34;items&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>register.goç”¨äºæŠŠç±»å‹æ³¨å†Œåˆ°å®¢æˆ·ç«¯ï¼Œæ ¸å¿ƒå°±æ˜¯addKnowTypeså‡½æ•°ï¼Œå®ƒæ˜¯éå¸¸å›ºå®šçš„ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">v1alpha1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span> <span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;kubernetesapi/pkg/apis/cnat&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SchemeGroupVersion is group version used to register these objects
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">SchemeGroupVersion</span> = <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupVersion</span>{<span style="color:#a6e22e">Group</span>: <span style="color:#a6e22e">cnat</span>.<span style="color:#a6e22e">GroupName</span>, <span style="color:#a6e22e">Version</span>: <span style="color:#a6e22e">cnat</span>.<span style="color:#a6e22e">Version</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Kind takes an unqualified kind and returns back a Group qualified GroupKind
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Kind</span>(<span style="color:#a6e22e">kind</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupKind</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">SchemeGroupVersion</span>.<span style="color:#a6e22e">WithKind</span>(<span style="color:#a6e22e">kind</span>).<span style="color:#a6e22e">GroupKind</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Resource takes an unqualified resource and returns a Group qualified GroupResource
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Resource</span>(<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">GroupResource</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">SchemeGroupVersion</span>.<span style="color:#a6e22e">WithResource</span>(<span style="color:#a6e22e">resource</span>).<span style="color:#a6e22e">GroupResource</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">SchemeBuilder</span> = <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">NewSchemeBuilder</span>(<span style="color:#a6e22e">addKnownTypes</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">AddToScheme</span>   = <span style="color:#a6e22e">SchemeBuilder</span>.<span style="color:#a6e22e">AddToScheme</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Adds the list of known types to Scheme.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">addKnownTypes</span>(<span style="color:#a6e22e">scheme</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Scheme</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">scheme</span>.<span style="color:#a6e22e">AddKnownTypes</span>(<span style="color:#a6e22e">SchemeGroupVersion</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">At</span>{},
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">AtList</span>{},
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">metav1</span>.<span style="color:#a6e22e">AddToGroupVersion</span>(<span style="color:#a6e22e">scheme</span>, <span style="color:#a6e22e">SchemeGroupVersion</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ä¸‹é¢è§£é‡Šä¸€ä¸‹ä¸Šé¢ä»£ç ä¸­å‡ºç°çš„ç”Ÿæˆå™¨æ³¨é‡Š</p>
<ul>
<li>// +k8s:deepcopy-gen=package
<ul>
<li>ä¸ºè¿™ä¸ªè‡ªå®šä¹‰ç±»å‹åˆ›å»ºæ·±æ‹·è´æ–¹æ³•ï¼Œè¿™æ˜¯æ¯ä¸ªç±»å‹éƒ½å¿…é¡»è¦æœ‰çš„ï¼Œä¸€èˆ¬æ”¾åœ¨doc.goæ–‡ä»¶é‡Œä½œä¸ºå…¨å±€çš„æ³¨é‡Šæ ‡ç­¾ã€‚</li>
</ul>
</li>
<li>// +groupName=cnat.programming-kubernetes.info
<ul>
<li>groupNameå’Œcrdé‡Œçš„groupä¿æŒä¸€è‡´ï¼Œä¸€èˆ¬æ”¾åœ¨doc.goæ–‡ä»¶é‡Œä½œä¸ºå…¨å±€çš„æ³¨é‡Šæ ‡ç­¾ã€‚</li>
</ul>
</li>
<li>// +genclient
<ul>
<li>è¿™ä¸ªæ³¨é‡Šè¡¨ç¤ºä¼šä¸ºè¯¥ç±»å‹ç”Ÿæˆå¼ºç±»å‹çš„cilentSet ä»¥åŠ informerå’Œlisterã€‚</li>
</ul>
</li>
<li>// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
<ul>
<li>å®ƒçš„æ„æ€æ˜¯ï¼Œè¯·åœ¨ç”Ÿæˆ DeepCopy çš„æ—¶å€™ï¼Œå®ç° Kubernetes æä¾›çš„ runtime.Object æ¥å£ã€‚å¦åˆ™ï¼Œåœ¨æŸäº›ç‰ˆæœ¬çš„ Kubernetes é‡Œï¼Œä½ çš„è¿™ä¸ªç±»å‹å®šä¹‰ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ã€‚è¿™æ˜¯ä¸€ä¸ªå›ºå®šçš„æ“ä½œï¼Œè®°ä½å³å¯ã€‚</li>
</ul>
</li>
</ul>
<p>æœ€åé€šè¿‡ä»£ç ç”Ÿæˆå·¥å…·ï¼Œå°±å¾—åˆ°äº†ä¸€ä¸ªè‡ªå®šä¹‰ç±»å‹çš„cientSetã€informerã€listerã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>generate-groups.sh &lt;generators&gt; &lt;output-package&gt; &lt;apis-package&gt; &lt;groups-versions&gt;
</span></span></code></pre></div><h1 id="è‡ªå®šä¹‰æ§åˆ¶å™¨">è‡ªå®šä¹‰æ§åˆ¶å™¨</h1>
<div align="center">
<img src="/custom-controller.png" height="40%" width="40%"></img>
<blockquote>
<p>custom controller</p>
</blockquote>
</div>
<p>ä¸Šå›¾å°±æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰æ§åˆ¶å™¨çš„å…¨è²Œï¼Œå®é™…ä¸Šå·¦åŠéƒ¨åˆ†æˆ‘ä»¬å·²ç»å¤šæ¬¡æåˆ°äº†ï¼Œkubenetes çš„apiæœåŠ¡å’Œ informerï¼Œå…¶ä¸­informerå¯ä»¥ç”¨client-goæ„å»ºï¼Œå¯¹äºè‡ªå®šä¹‰ç±»å‹ä¹Ÿå¯ä»¥ä½¿ç”¨k8s.io/code-generatoræ„å»ºã€‚</p>
<p>æœ‰äº†informerï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€å—ç¼“å­˜ï¼Œé‡Œé¢ä¿å­˜çš„æ˜¯æˆ‘ä»¬æƒ³è¦çš„kubernetesèµ„æºï¼Œå¹¶ä¸”å¯ä»¥ç›‘å¬å®ƒçš„å˜åŒ–ã€‚è¿™é‡Œçš„å˜åŒ–ä¸€èˆ¬éƒ½æ˜¯ç”¨æˆ·ä¿®æ”¹äº†èµ„æºçš„specå­—æ®µï¼Œè¿™æ˜¯èµ„æºçš„æœŸæœ›çŠ¶æ€ï¼ŒæœŸæœ›çŠ¶æ€æœ‰äº†å˜åŒ–ä¹‹åè¯¥æ€ä¹ˆåŠå‘¢ï¼Œå°±æ˜¯å›¾ä¸­å³åŠéƒ¨åˆ†è¦åšçš„äº‹ã€‚</p>
<p><strong>controllerè‡ªå·±æœ‰ä¸€ä¸ªå·¥ä½œé˜Ÿåˆ—ï¼Œinformerä¼šæŠŠéœ€è¦å¤„ç†çš„èµ„æºå¯¹è±¡æ”¾åˆ°é˜Ÿåˆ—é‡Œï¼Œcontrolleræ¯æ¬¡ä»é˜Ÿåˆ—é‡Œå–å‡ºèµ„æºéƒ½ä¼šæ£€æŸ¥ä»–çš„å®é™…çŠ¶æ€ï¼ˆé€šè¿‡ç›‘æ§ç³»ç»Ÿï¼‰ä¸æœŸæœ›çŠ¶æ€æ˜¯å¦ç›¸ç¬¦ï¼Œå¦‚æœç›¸ç¬¦å°±ä¸éœ€è¦æ“ä½œï¼Œä¹Ÿä¸ç”¨å†æ”¾å›é˜Ÿåˆ—é‡Œã€‚å¦‚æœä¸ç›¸ç¬¦ï¼Œé‚£ä¹ˆæ§åˆ¶å™¨éœ€è¦è¿›è¡Œè°ƒè°ï¼Œæ”¹å˜å®é™…çŠ¶æ€ï¼Œå¦‚æœæ”¹å˜æˆåŠŸï¼Œå°±æ›´æ–°èµ„æºçš„statusï¼ŒåŒæ—¶ä¸ç”¨å†æ”¾å›é˜Ÿåˆ—é‡Œäº†ï¼Œå¦‚æœæ”¹å˜å¤±è´¥è¿˜è¦æ”¾å›é˜Ÿåˆ—é‡Œï¼Œç­‰å¾…ä¸‹è½®å¾ªç¯ç»§ç»­å¤„ç†ã€‚</strong></p>
<h1 id="operator">Operator</h1>
<p><strong>Operatorå®é™…ä¸Šå°±æ˜¯ä¸Šé¢è®²åˆ°çš„è‡ªå®šä¹‰èµ„æº(CR)è‡ªå®šä¹‰èµ„æºçš„å®šä¹‰(CRD)å’Œç”¨æˆ·çš„è‡ªå®šä¹‰æ§åˆ¶å™¨çš„ä¸€ä¸ªæ€»ç§°ï¼Œå†ç»†åˆ†ä¸€ä¸‹å°±æ˜¯CR+CRD+informer+workQueue+ContorllerLoopã€‚</strong></p>
<p>å®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨kubebuilderæˆ–è€…operator SDKæ¥ç¼–å†™operatorã€‚æœ¬æ–‡ä¼šä»‹ç»kubebuilderçš„æ ¸å¿ƒç”¨æ³•ã€‚</p>
<h2 id="ä½¿ç”¨kubebuilder">ä½¿ç”¨kubebuilder</h2>
<p>å› ä¸ºç”¨åˆ°äº†go modï¼Œä½¿ç”¨kubebuilderå‰éœ€è¦å…ˆåˆå§‹åŒ–ä¸€ä¸ªgo mod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">go</span> <span style="color:#a6e22e">mod</span> <span style="color:#a6e22e">init</span> <span style="color:#a6e22e">my</span>.<span style="color:#a6e22e">domain</span>
</span></span></code></pre></div><p>ç„¶åä½¿ç”¨kubebuilderåˆå§‹åŒ–é¡¹ç›®ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubebuilder init my.domain
</span></span></code></pre></div><p>åˆ›å»ºapiï¼Œè¿™ä¸€æ­¥ä¼šå¸®æˆ‘ä»¬åˆ›å»ºå¥½controllerçš„æ¡†æ¶å’Œresourceï¼ŒåŒæ—¶å®šä¹‰å¥½äº†èµ„æºçš„GVKã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubebuilder create api --group webapp --version v1 --kind Guestbook
</span></span></code></pre></div><p>æ­¤æ—¶åœ¨config/crd/å½“ä¸­crdçš„ç”Ÿæˆæ¨¡ç‰ˆå°±å·²ç»åˆ›å»ºå¥½äº†ï¼Œconfig/samples/é‡Œæœ‰ä¸€ä¸ªå¯¹åº”çš„CRå¯ä¾›æµ‹è¯•ã€‚å¹¶ä¸”å¯¹äºè¿™ä¸ªCRçš„informerå’ŒworkQueueã€controllerLoopçš„æ¡†æ¶éƒ½å·²ç»æ­å»ºå¥½äº†ï¼Œéœ€è¦æˆ‘ä»¬ä¿®æ”¹çš„æ˜¯api/v1/guestbook_types.goå’Œcontrollers/guestbook_controller.goï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶å®šä¹‰çš„åˆ†åˆ«æ˜¯æˆ‘çš„èµ„æºæœ‰é‚£äº›ä¿¡æ¯ï¼Œä»¥åŠå¦‚ä½•è°ƒè°ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">GuestbookReconciler</span>) <span style="color:#a6e22e">Reconcile</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">req</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Request</span>) (<span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">FromContext</span>(<span style="color:#a6e22e">ctx</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">instance</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">webappv1</span>.<span style="color:#a6e22e">Guestbook</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">NamespacedName</span>, <span style="color:#a6e22e">instance</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">IsNotFound</span>(<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// Request object not found, could have been deleted after reconcile request - return and don&#39;t requeue:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reconcile</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Error reading the object - requeue the request:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">reconcile</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		get instance real status by monitoring
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Update the At instance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Status</span>().<span style="color:#a6e22e">Update</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">TODO</span>(), <span style="color:#a6e22e">instance</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ctrl</span>.<span style="color:#a6e22e">Result</span>{}, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯ç”¨æ¥å®ç°è°ƒè°é€»è¾‘çš„ï¼Œå…¶ä¸­reqå°±æ˜¯ä»workQueueä¸­å–å‡ºæ¥çš„å¾…å¤„ç†çš„å¯¹è±¡ï¼ŒåªåŒ…å«äº†äº†nameå’ŒNamespaceï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å»informerçš„ç¼“å­˜ä¸­æ‹¿å‡ºå®Œæ•´çš„å®šä¹‰æ¥ï¼Œç„¶åæŸ¥çœ‹èµ„æºçš„å®é™…çŠ¶æ€ã€‚</p>
<p><strong>å…¶ä¸­ä»workQueueé‡Œå–å‡ºå¾…è°ƒè°å¯¹è±¡åå»informeræŸ¥æœ€æ–°æƒ…å†µä¹Ÿä½“ç°äº†kubernetesåªå…³å¿ƒæœ€ç»ˆçŠ¶æ€çš„è®¾è®¡ç‰¹ç‚¹ï¼Œå¦å¤–å¯¹äºnotfoundçš„errè¦å¿½ç•¥ï¼Œå› ä¸ºå®ƒæ— æ³•é€šè¿‡é‡è¯•è§£å†³ã€‚</strong></p>
<p>kubebuilderç”Ÿæˆçš„makefileæ–‡ä»¶é‡Œï¼Œè¿˜å®šä¹‰äº†å¦‚ä½•æ‰“åŒ…éƒ¨ç½²çš„è„šæœ¬ï¼Œå…·ä½“ä½¿ç”¨å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚</p>
<h3 id="å‡†å…¥-webhooks">å‡†å…¥ Webhooks</h3>
<p>å‡†å…¥ webhook æ˜¯ HTTP çš„å›è°ƒï¼Œå®ƒå¯ä»¥æ¥å—å‡†å…¥è¯·æ±‚ï¼Œå¤„ç†å®ƒä»¬å¹¶ä¸”è¿”å›å‡†å…¥å“åº”ã€‚</p>
<p>Kubernetes æä¾›äº†ä¸‹é¢å‡ ç§ç±»å‹çš„å‡†å…¥ webhookï¼š</p>
<ul>
<li><strong>å˜æ›´å‡†å…¥ Webhook</strong> è¿™ç§ç±»å‹çš„ webhook ä¼šåœ¨å¯¹è±¡åˆ›å»ºæˆ–æ˜¯æ›´æ–°ä¸”æ²¡æœ‰å­˜å‚¨å‰æ”¹å˜æ“ä½œå¯¹è±¡ï¼Œç„¶åæ‰å­˜å‚¨ã€‚å®ƒå¯ä»¥ç”¨äºèµ„æºè¯·æ±‚ä¸­çš„é»˜è®¤å­—æ®µï¼Œæ¯”å¦‚åœ¨ Deployment ä¸­æ²¡æœ‰è¢«ç”¨æˆ·åˆ¶å®šçš„å­—æ®µã€‚å®ƒå¯ä»¥ç”¨äºæ³¨å…¥ sidecar å®¹å™¨ã€‚</li>
<li><strong>éªŒè¯å‡†å…¥ Webhook</strong> è¿™ç§ç±»å‹çš„ webhook ä¼šåœ¨å¯¹è±¡åˆ›å»ºæˆ–æ˜¯æ›´æ–°ä¸”æ²¡æœ‰å­˜å‚¨å‰éªŒè¯æ“ä½œå¯¹è±¡ï¼Œç„¶åæ‰å­˜å‚¨ã€‚å®ƒå¯ä»¥æœ‰æ¯”çº¯åŸºäº schema éªŒè¯æ›´åŠ å¤æ‚çš„éªŒè¯ã€‚æ¯”å¦‚ï¼šäº¤å‰å­—æ®µéªŒè¯å’Œ pod é•œåƒç™½åå•ã€‚</li>
</ul>
<p>åˆ©ç”¨kubebuilderå®ç°è¿™ä¸¤ä¸ªwebhookéå¸¸å®¹æ˜“ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubebuilder create webhook --group webapp --version v1 --kind Guestbook --defaulting --programmatic-validation
</span></span></code></pre></div><p>å…¶ä¸­å‚æ•°&ndash;defaulting &ndash;programmatic-validationä»£è¡¨æˆ‘ä»¬éœ€è¦ä¸Šè¿°ä¸¤ç§webhookã€‚å‘½ä»¤æ‰§è¡ŒæˆåŠŸåä¼šåœ¨api/v1ç›®å½•ä¸‹æ‰¾åˆ°å¯¹åº”çš„webhookæ–‡ä»¶ï¼Œå…¶ä¸­Default()æ–¹æ³•ç”¨æ¥ä¿®æ”¹apiå¯¹è±¡ï¼Œæ¯”å¦‚æ³¨å…¥ä¸€äº›é»˜è®¤å€¼ã€‚å¦å¤–è¿˜æœ‰3ä¸ªValidateæ–¹æ³•ï¼Œåˆ†åˆ«å¯¹apiå¯¹è±¡çš„åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤åŠ¨ä½œè¿›è¡Œæ‹¦æˆªï¼Œæ£€æµ‹å­—æ®µæ˜¯å¦åˆæ³•ï¼Œè¿™é‡Œå¯ä»¥å®ç°æ¯”crdä¸­çš„schemaæ›´ä¸ºå®Œå–„çš„æ£€æµ‹æœºåˆ¶ã€‚</p></section>

  
  
  <footer class="mt-12 flex flex-wrap">
     
    <a
      class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]"
      href="/tags/kubernetes"
      >kubernetes</a
    >
     
    <a
      class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]"
      href="/tags/cloud-native"
      >cloud-native</a
    >
     
    <a
      class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-1.5 no-underline dark:bg-white/[8%]"
      href="/tags/golang"
      >golang</a
    >
    
  </footer>
  

  
  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a
      class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="/posts/dns/"
      ><span class="mr-1.5">â†</span><span>DNSè§£æé”™äº†ã€ä¸å¤Ÿæ™ºèƒ½ã€è§£ææ…¢è¯¥æ€ä¹ˆè§£å†³ï¼Ÿ</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="/posts/grpc/"
      ><span>grpc</span><span class="ml-1.5">â†’</span></a
    >
    
  </nav>
  
  

  
  

  
  

  
  
</article>


    </main>

    <footer
  class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"
>
  <div class="mr-auto">
    &copy; 2024
    <a class="link" href="/">ğŸ¶</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >Powered by Hugoï¸ï¸</a
  >ï¸
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >âœ Paper</a
  >
</footer>

  </body>
</html>
